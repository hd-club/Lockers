<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Hedo ‚Äì Casier (RFID/QR) ‚Äì Kiosk + Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root{--bg:#0d0f13;--panel:#141821;--text:#e9eef6;--muted:#9aa4b2;--accent:#D4AF37;--ok:#2ecc71;--warn:#f39c12;--danger:#e74c3c;--border:rgba(255,255,255,.12)}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{min-height:100vh;display:flex;flex-direction:column}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
    .title{font-weight:700;letter-spacing:.3px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .btn,.input,.select,textarea{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px}
    .btn{cursor:pointer}
    .btn.accent{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
    main{padding:18px;display:grid;grid-template-columns:1fr;gap:18px;flex:1}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    h3{margin:0 0 10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .note{font-size:12px;color:var(--muted)}
    .kiosk{display:flex;align-items:center;justify-content:center;min-height:240px;border:2px dashed var(--border);border-radius:12px;text-align:center}
    .big{font-size:64px;font-weight:800;letter-spacing:1px;color:var(--accent)}
    .muted{color:var(--muted)}
    .hidden{position:absolute;left:-9999px;top:-9999px;opacity:0}
    .grid{width:100%;border-collapse:collapse;margin-top:10px}
    .grid th,.grid td{padding:10px 8px;border-bottom:1px solid var(--border);font-size:14px;text-align:left}
    textarea{width:100%;min-height:140px}
    footer{padding:12px 18px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)}
    @media (min-width:1100px){main{grid-template-columns:1.1fr .9fr}}

    /* Indicateur cam√©ra discret (en haut) */
    .cam-status{display:flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--danger)}

    /* Bouton flottant mobile pour la cam√©ra */
    .fab{
      position:fixed; right:16px; bottom:16px; z-index:50;
      background:var(--accent); color:#000; border:none;
      border-radius:999px; padding:14px 16px; font-weight:700; box-shadow:0 8px 24px rgba(0,0,0,.35);
    }
    .fab.alt{ background:var(--panel); color:var(--text); border:1px solid var(--border) }
    @media (min-width: 900px){ .fab{ display:none; } } /* bouton visible surtout sur mobile */
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">Hedo ‚Äì Casier (RFID 125 kHz / QR)</div>
    <div class="tabs">
      <button class="btn accent" id="tab-kiosk">Kiosk</button>
      <button class="btn" id="tab-admin">Admin</button>
      <button class="btn" id="tab-tools">Import/Export</button>
      <button class="btn" id="btn-reset" title="Efface la config locale">R√©initialiser (local)</button>
    </div>
    <div class="cam-status">
      <span class="dot warn" id="cam-dot" title="√âtat cam√©ra"></span>
      <span id="cam-label" class="note">Cam√©ra : init‚Ä¶</span>
      <button class="btn" id="cam-restart" title="Relancer la capture">Relancer</button>
    </div>
  </header>

  <main>
    <!-- KIOSK -->
    <section class="panel" id="view-kiosk">
      <h3>√âcran client</h3>
      <div class="note">
        La <b>douchette USB</b> (RFID/QR en mode clavier) est captur√©e en permanence.
        Le <b>scan QR via cam√©ra</b> peut tourner en arri√®re-plan (flux non affich√©).
      </div>

      <!-- input cach√© pour capter tous les scans clavier (lecteur USB) -->
      <input id="hidden-capture" class="hidden" aria-hidden="true" />

      <!-- vid√©o/canvas invisibles -->
      <video id="qr-video" class="hidden" muted playsinline></video>
      <canvas id="qr-canvas" class="hidden"></canvas>

      <div class="kiosk" id="kiosk-box" style="margin-top:12px">
        <div id="kiosk-content" class="muted">Scannez votre bracelet‚Ä¶</div>
      </div>
      <div id="kiosk-error" class="note" style="color:var(--danger);margin-top:8px"></div>
    </section>

    <!-- ADMIN -->
    <section class="panel" id="view-admin" style="display:none">
      <h3>Administration ‚Äî Mapping UID ‚Üî Casier</h3>
      <div class="row">
        <input class="input" id="search" placeholder="Rechercher (casier, UID)‚Ä¶" />
        <button class="btn" id="add-row">Ajouter une ligne</button>
        <button class="btn" id="gen-sample">G√©n√©rer casiers 101‚Äì160 (VIDES)</button>
      </div>
      <table class="grid" id="map-table">
        <thead><tr><th># Casier</th><th>UID (lecture seule 125 kHz ou contenu QR)</th><th>Actions</th></tr></thead>
        <tbody id="map-body"></tbody>
      </table>
      <div class="note" style="margin-top:8px">
        Astuce : clique ‚ÄúScanner ici‚Äù dans une ligne pour capturer le prochain scan clavier directement dans le champ UID.
      </div>
    </section>

    <!-- TOOLS -->
    <section class="panel" id="view-tools" style="display:none">
      <h3>Import / Export</h3>
      <div class="row">
        <button class="btn accent" id="btn-export-json">Exporter JSON</button>
        <button class="btn" id="btn-export-csv">Exporter CSV</button>
      </div>
      <div class="row" style="margin-top:10px">
        <textarea id="import-area" placeholder='Colle ici un JSON [{"locker":101,"uid":"ABC123"},‚Ä¶] ou CSV locker,uid'></textarea>
      </div>
      <div class="row">
        <button class="btn" id="btn-import-json">Importer JSON</button>
        <button class="btn" id="btn-import-csv">Importer CSV</button>
      </div>
      <div class="note" style="margin-top:8px">
        Les donn√©es sont stock√©es dans ce navigateur (localStorage). Tu pourras brancher une API plus tard.
      </div>
    </section>
  </main>

  <footer>Hedo ‚Äî aucune donn√©e nominative ; uniquement la correspondance UID ‚Üî num√©ro de casier.</footer>
</div>

<!-- Bouton flottant mobile pour d√©marrer/arr√™ter la cam√©ra -->
<button id="fab-camera" class="fab" aria-pressed="false" aria-label="Activer la cam√©ra">
  üì∑ Activer cam√©ra
</button>

<script>
/* =========================
   Stockage local
========================= */
const LS_KEY = "hedo_map_v3";
function loadState(){ const raw = localStorage.getItem(LS_KEY); if(raw) try{return JSON.parse(raw)}catch{} const init={map:[],lastScan:null}; localStorage.setItem(LS_KEY,JSON.stringify(init)); return init; }
function saveState(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
let state = loadState();

/* =========================
   Helpers
========================= */
function normalizeToken(s){
  if(!s) return "";
  let str = String(s).trim().replace(/[\r\n\t]/g,"");
  if(str.length>=5) return str;
  const hex=(str.match(/[0-9A-Fa-f]{6,}/)||[null])[0]; if(hex) return hex.toUpperCase();
  const dec=(str.match(/[0-9]{6,}/)||[null])[0]; if(dec) return dec;
  return str;
}
function findLockerByUID(uid){ const n=normalizeToken(uid); return state.map.find(r => (r.uid||"")===n) || null; }
function findByLocker(locker){ const L=Number(locker); return state.map.find(r=>r.locker===L) || null; }
function upsertRow(locker, uid){ const L=Number(locker); const n=normalizeToken(uid); let row=findByLocker(L); if(row){ row.uid=n } else { state.map.push({ locker:L, uid:n }) } saveState(state); }
function deleteRow(locker){ const L=Number(locker); state.map = state.map.filter(r=>r.locker!==L); saveState(state); }

/* =========================
   UI ‚Äì navigation
========================= */
const viewKiosk=document.getElementById("view-kiosk");
const viewAdmin=document.getElementById("view-admin");
const viewTools=document.getElementById("view-tools");
const tabKiosk=document.getElementById("tab-kiosk");
const tabAdmin=document.getElementById("tab-admin");
const tabTools=document.getElementById("tab-tools");
function setTab(name){
  viewKiosk.style.display = (name==="kiosk")?"block":"none";
  viewAdmin.style.display = (name==="admin")?"block":"none";
  viewTools.style.display = (name==="tools")?"block":"none";
  tabKiosk.classList.toggle("accent", name==="kiosk");
  tabAdmin.classList.toggle("accent", name==="admin");
  tabTools.classList.toggle("accent", name==="tools");
}
tabKiosk.onclick = ()=>setTab("kiosk");
tabAdmin.onclick = ()=>{ setTab("admin"); renderTable(); };
tabTools.onclick = ()=>setTab("tools");
setTab("kiosk");

/* =========================
   KIOSK ‚Äì douchette USB (clavier)
========================= */
const hiddenInput=document.getElementById("hidden-capture");
const kioskContent=document.getElementById("kiosk-content");
const kioskError=document.getElementById("kiosk-error");
const kioskBox=document.getElementById("kiosk-box");
let buffer="";

function showLocker(locker){
  kioskError.textContent="";
  if(locker){ kioskContent.innerHTML = '<div class="muted">Votre casier est le</div><div class="big">#'+locker+'</div>'; }
  else { kioskContent.innerHTML = '<span class="muted">Aucun casier trouv√© pour cet identifiant.</span>'; }
}
function handleScan(raw){
  const token=normalizeToken(raw);
  if(!token || token.length<5) return;
  state.lastScan=token; saveState(state);
  const row=findLockerByUID(token);
  showLocker(row?row.locker:null);
}
function focusCapture(){ hiddenInput.focus(); }
hiddenInput.addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){ const data=buffer; buffer=""; handleScan(data); }
  else if(e.key.length===1){ buffer+=e.key; }
  else if(e.key==="Backspace"){ buffer=buffer.slice(0,-1); }
});
kioskBox.addEventListener("click", focusCapture);
document.addEventListener("click", (e)=>{ if(viewKiosk.contains(e.target)) setTimeout(focusCapture,0); });
focusCapture();

/* =========================
   CAM√âRA ‚Äî d√©marrage sur geste (bouton mobile) + auto/restart desktop
========================= */
const video = document.getElementById("qr-video");   // cach√©
const canvas = document.getElementById("qr-canvas"); // cach√©
const camDot = document.getElementById("cam-dot");
const camLabel = document.getElementById("cam-label");
const camRestartBtn = document.getElementById("cam-restart");
const fabCamera = document.getElementById("fab-camera");

let qrTimer=null, detector=null, stream=null, cameraRunning=false;

function setCamStatus(kind,msg){
  camDot.className = "dot " + (kind||"warn");
  camLabel.textContent = "Cam√©ra : " + (msg||"");
  // Met √† jour le libell√© du bouton flottant mobile
  if (cameraRunning){
    fabCamera.textContent = "‚èπÔ∏è Arr√™ter cam√©ra";
    fabCamera.classList.add("alt");
    fabCamera.setAttribute("aria-pressed","true");
  } else {
    fabCamera.textContent = "üì∑ Activer cam√©ra";
    fabCamera.classList.remove("alt");
    fabCamera.setAttribute("aria-pressed","false");
  }
}

async function startCamera(){
  stopCamera(); // s√©curit√©
  if(!("BarcodeDetector" in window)){
    setCamStatus("err","non support√©e (utilisez douchette USB)");
    return;
  }
  setCamStatus("warn","d√©marrage‚Ä¶");
  try{
    detector = new window.BarcodeDetector({ formats:["qr_code"] });
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    video.srcObject = stream;
    await video.play();
    cameraRunning = true;
    setCamStatus("ok","op√©rationnelle");
    // boucle de d√©tection
    qrTimer = setInterval(async ()=>{
      if(!video.videoWidth){ return; }
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d", { willReadFrequently:true });
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      try{
        const codes = await detector.detect(canvas);
        if(codes && codes.length){
          const text = codes[0].rawValue || "";
          if(text){ handleScan(text); }
        }
      }catch(_){}
    }, 350);

    // auto-recover si la piste s'arr√™te
    stream.getVideoTracks().forEach(tr=>{
      tr.onended = () => { cameraRunning=false; setCamStatus("warn","red√©marrage‚Ä¶"); setTimeout(()=>startCamera(), 800); };
    });
  }catch(e){
    cameraRunning=false;
    setCamStatus("err", e?.message || "erreur autorisation");
  }
}
function stopCamera(){
  if(qrTimer){ clearInterval(qrTimer); qrTimer=null; }
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  video.srcObject = null;
  cameraRunning=false;
  setCamStatus("warn","arr√™t√©e");
}

/* Bouton flottant : mobile/desktop */
fabCamera.addEventListener("click", async ()=>{
  if(cameraRunning){ stopCamera(); }
  else { await startCamera(); }
});

/* Bouton ‚ÄúRelancer‚Äù (en-t√™te) */
camRestartBtn.onclick = ()=>startCamera();

/* Politique :
   - Desktop : on tente un d√©marrage auto √† l‚Äôouverture (fonctionnait d√©j√†) ;
   - Mobile : certains navigateurs exigent un geste ‚Üí l‚Äôutilisateur utilise le bouton.
*/
window.addEventListener("load", ()=>{
  // tentative auto (desktop). S'il faut un geste, le bouton servira.
  startCamera();
});

/* Relance si onglet remis au premier plan */
document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState==="visible"){
    // si la cam√©ra √©tait en cours, on (re)lance ; sinon on ne force pas (mobile)
    if(cameraRunning){ startCamera(); }
    focusCapture();
  }
});

/* =========================
   ADMIN ‚Äì table mapping
========================= */
const mapBody=document.getElementById("map-body");
const search=document.getElementById("search");
function renderTable(){
  const q=(search.value||"").toLowerCase();
  const rows = state.map
    .slice()
    .sort((a,b)=>a.locker-b.locker)
    .filter(r=>!q || String(r.locker).includes(q) || (r.uid||"").toLowerCase().includes(q));
  mapBody.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td style="width:110px"><input class="input locker-input" value="${r.locker}" style="width:100%"/></td>
      <td>
        <div class="row" style="gap:6px">
          <input class="input uid-input" value="${r.uid||""}" placeholder="Scanner ici‚Ä¶" style="flex:1" />
          <button class="btn scan-btn">Scanner ici</button>
          <button class="btn" title="Vider" data-action="clear">‚úï</button>
        </div>
      </td>
      <td>
        <div class="row" style="gap:6px">
          <button class="btn accent save-btn">Enregistrer</button>
          <button class="btn" style="border-color:var(--danger);color:var(--danger)" title="Supprimer">Supprimer</button>
        </div>
      </td>`;
    mapBody.appendChild(tr);

    const lockerEl = tr.querySelector(".locker-input");
    const uidEl = tr.querySelector(".uid-input");
    const scanBtn = tr.querySelector(".scan-btn");
    const saveBtn = tr.querySelector(".save-btn");
    const delBtn = tr.querySelector('[title="Supprimer"]');
    const clearBtn = tr.querySelector('[data-action="clear"]');

    // ‚ÄúScanner ici‚Äù : capter le prochain scan clavier dans ce champ
    scanBtn.addEventListener("click", ()=>{
      uidEl.focus(); uidEl.value="";
      const handler=(e)=>{
        if(e.key==="Enter"){
          uidEl.value = normalizeToken(uidEl.value);
          document.removeEventListener("keydown", handler, true);
        }
      };
      document.addEventListener("keydown", handler, true);
    });

    clearBtn.addEventListener("click", ()=>{ uidEl.value=""; });

    saveBtn.addEventListener("click", ()=>{
      const L=Number(lockerEl.value);
      const U=normalizeToken(uidEl.value);
      if(!L){ alert("Num√©ro de casier invalide."); return; }
      if(U && state.map.some(x=>x.uid===U && x.locker!==L)){
        if(!confirm("Cet UID est d√©j√† attribu√© √† un autre casier. Continuer ?")) return;
      }
      upsertRow(L,U); renderTable();
    });

    delBtn.addEventListener("click", ()=>{
      if(confirm("Supprimer cette ligne ?")){
        deleteRow(lockerEl.value); renderTable();
      }
    });
  });
}
search.addEventListener("input", renderTable);
document.getElementById("add-row").onclick=()=>{ state.map.push({ locker:0, uid:"" }); saveState(state); renderTable(); };
document.getElementById("gen-sample").onclick=()=>{
  if(!confirm("Cr√©er/√©craser les casiers 101‚Äì160 (UID vides) ?")) return;
  const set=new Set(state.map.map(r=>r.locker));
  for(let n=101;n<=160;n++){ if(!set.has(n)) state.map.push({ locker:n, uid:"" }); }
  saveState(state); renderTable();
};

/* =========================
   Import / Export
========================= */
const area=document.getElementById("import-area");
document.getElementById("btn-export-json").onclick=()=>{
  const data=JSON.stringify(state.map,null,2); downloadText("hedo-lockers.json", data);
};
document.getElementById("btn-export-csv").onclick=()=>{
  const rows=[["locker","uid"], ...state.map.map(r=>[r.locker, r.uid||""])];
  const csv=rows.map(r=>r.map(c=>String(c).replace(/"/g,'""')).join(",")).join("\n");
  downloadText("hedo-lockers.csv", csv);
};
document.getElementById("btn-import-json").onclick=()=>{
  try{
    const arr=JSON.parse(area.value);
    if(!Array.isArray(arr)) throw new Error("JSON invalide");
    state.map = arr.map(o=>({ locker:Number(o.locker), uid: normalizeToken(o.uid||"") })).filter(o=>o.locker);
    saveState(state); renderTable(); alert("Import JSON OK");
  }catch(e){ alert("Erreur import JSON : "+e.message); }
};
document.getElementById("btn-import-csv").onclick=()=>{
  try{
    const lines=area.value.trim().split(/\r?\n/); const out=[];
    for(let i=0;i<lines.length;i++){
      const line=lines[i].trim(); if(!line) continue;
      const parts=line.split(",");
      if(i===0 && /locker/i.test(parts[0])) continue; // header
      const locker=Number(parts[0]); const uid=normalizeToken(parts[1]||"");
      if(locker) out.push({ locker, uid });
    }
    state.map=out; saveState(state); renderTable(); alert("Import CSV OK");
  }catch(e){ alert("Erreur import CSV : "+e.message); }
};
function downloadText(filename, text){
  const blob=new Blob([text], {type:"text/plain;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}

/* =========================
   Reset local
========================= */
document.getElementById("btn-reset").onclick=()=>{
  if(!confirm("R√©initialiser toutes les donn√©es locales ?")) return;
  localStorage.removeItem(LS_KEY); state=loadState(); renderTable();
  kioskContent.textContent="Scannez votre bracelet‚Ä¶"; kioskError.textContent="";
};

/* =========================
   D√©marrage
========================= */
renderTable();
</script>
</body>
</html>