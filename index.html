<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Hedo Lockers</title>

<meta name="theme-color" content="#0d0f13" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />
<link rel="manifest" href="manifest.webmanifest" />

<!-- ZXing pour lecture QR -->
<script defer src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>

<style>
/* (m√™me CSS que ta version pr√©c√©dente, je n‚Äôai pas modifi√©) */
body{margin:0;background:#0d0f13;color:#e9eef6;font-family:system-ui,sans-serif}
.btn{background:#141821;border:1px solid rgba(255,255,255,.12);color:#e9eef6;padding:10px 12px;border-radius:10px;cursor:pointer}
.btn.accent{border-color:#D4AF37}
.panel{background:#141821;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;margin:10px}
.kiosk{display:flex;align-items:center;justify-content:center;min-height:200px;border:2px dashed rgba(255,255,255,.12);border-radius:12px}
.big{font-size:64px;font-weight:800;color:#D4AF37}
.hidden{position:absolute;left:-9999px}
.fab{position:fixed;right:16px;bottom:16px;background:#D4AF37;border:none;border-radius:999px;padding:14px 16px;z-index:100}
</style>
</head>
<body>
<div class="panel">
  <h3>√âcran client</h3>
  <input id="hidden-capture" class="hidden" />
  <video id="qr-video" muted playsinline style="width:2px;height:2px;opacity:0;position:fixed;left:0;bottom:0"></video>
  <div class="kiosk"><div id="kiosk-content">Scannez votre bracelet‚Ä¶</div></div>
  <div id="kiosk-error" style="color:red"></div>
</div>

<div class="panel" id="view-admin">
  <h3>Admin</h3>
  <div>
    <input class="btn" id="admin-email" placeholder="email admin" />
    <button class="btn" id="btn-login">Se connecter</button>
    <button class="btn" id="btn-logout">D√©connexion</button>
    <span id="auth-status"></span>
  </div>
  <table id="map-table" border="1" style="margin-top:10px;width:100%"><thead><tr><th>Casier</th><th>UID</th><th></th></tr></thead><tbody id="map-body"></tbody></table>
  <button class="btn accent" id="add-row">Ajouter une ligne</button>
</div>

<button id="fab-camera" class="fab">üì∑ Cam√©ra</button>

<script type="module">
/* ================= FIREBASE INIT ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc, getDocs, collection, query, orderBy, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZ7M8dUKqcUwa9rDyWEdHEwnFVPlrpCds",
  authDomain: "lockers-26331.firebaseapp.com",
  projectId: "lockers-26331",
  storageBucket: "lockers-26331.firebasestorage.app",
  messagingSenderId: "601816918378",
  appId: "1:601816918378:web:b6045b10b60e7957c19d13"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ================= GLOBAL STATE ================= */
let state = { map: [] };
const kioskContent = document.getElementById("kiosk-content");
function normalizeToken(s){ return (s||"").trim(); }
function showLocker(locker){ kioskContent.innerHTML = locker ? `<div>Votre casier</div><div class="big">#${locker}</div>` : "<span>Aucun casier trouv√©</span>"; }

/* ================= FIRESTORE DAO ================= */
const LOCKERS = () => collection(db,"lockers");
const LOCKER_DOC = (id)=> doc(db,"lockers",String(id));

async function dbFetchAll(){
  const qs = await getDocs(query(LOCKERS(), orderBy("locker")));
  return qs.docs.map(d=>({ locker:Number(d.id), ...(d.data()||{}) }));
}
async function dbUpsert(locker, uid){
  await setDoc(LOCKER_DOC(locker), { locker:Number(locker), uid:uid||null, updatedAt:serverTimestamp() }, { merge:true });
}
async function dbDelete(locker){ await deleteDoc(LOCKER_DOC(locker)); }
async function dbFindByUID(uid){
  const qs = await getDocs(query(LOCKERS(), where("uid","==",uid)));
  if(qs.empty) return null;
  return qs.docs[0].data().locker;
}

/* ================= ADMIN UI ================= */
const mapBody = document.getElementById("map-body");
function renderTable(){
  mapBody.innerHTML="";
  state.map.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><input value="${r.locker||""}" class="locker"/></td>
      <td><input value="${r.uid||""}" class="uid"/></td>
      <td><button class="save">üíæ</button><button class="del">üóëÔ∏è</button></td>`;
    mapBody.appendChild(tr);
    tr.querySelector(".save").onclick=async()=>{
      await dbUpsert(tr.querySelector(".locker").value, tr.querySelector(".uid").value);
    };
    tr.querySelector(".del").onclick=async()=>{
      await dbDelete(tr.querySelector(".locker").value);
    };
  });
}
document.getElementById("add-row").onclick=()=>{ state.map.push({locker:0,uid:""}); renderTable(); };

/* ================= FIREBASE AUTH ================= */
const emailInput=document.getElementById("admin-email");
document.getElementById("btn-login").onclick=async()=>{
  const email=emailInput.value;
  await sendSignInLinkToEmail(auth,email,{url:window.location.href,handleCodeInApp:true});
  localStorage.setItem("hedo_email",email);
  alert("Lien envoy√© √† "+email);
};
document.getElementById("btn-logout").onclick=()=>signOut(auth);

window.addEventListener("load", async()=>{
  if(isSignInWithEmailLink(auth, window.location.href)){
    const email=localStorage.getItem("hedo_email")||prompt("Email ?");
    await signInWithEmailLink(auth,email,window.location.href);
    localStorage.removeItem("hedo_email");
  }
});
onAuthStateChanged(auth,u=>{
  document.getElementById("auth-status").textContent=u?("Connect√©: "+u.email):"Non connect√©";
});

/* ================= REALTIME SYNC ================= */
onSnapshot(LOCKERS(),snap=>{
  state.map=snap.docs.map(d=>({ locker:Number(d.id), ...(d.data()||{}) }));
  renderTable();
});

/* ================= KIOSK SCAN ================= */
function handleScan(val){
  const token=normalizeToken(val);
  if(!token) return;
  const row=state.map.find(r=>r.uid===token);
  if(row){ showLocker(row.locker); return; }
  dbFindByUID(token).then(l=>showLocker(l));
}

/* ================= QR CAMERA ================= */
import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js";
const fab=document.getElementById("fab-camera");
let reader=null;
fab.onclick=async()=>{
  if(reader){ reader.reset(); reader=null; fab.textContent="üì∑ Cam√©ra"; return; }
  reader=new BrowserMultiFormatReader();
  await reader.decodeFromConstraints({video:{facingMode:"environment"}}, document.getElementById("qr-video"),
    (res,err)=>{ if(res?.getText) handleScan(res.getText()); });
  fab.textContent="‚èπÔ∏è Stop";
};
</script>
</body>
</html>