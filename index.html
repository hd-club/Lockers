<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Hedo Lockers</title>

<!-- PWA -->
<meta name="theme-color" content="#0d0f13" />
<link rel="manifest" href="manifest.webmanifest" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />

<!-- ZXing (QR) -->
<script defer src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>

<style>
:root{
  --bg:#0d0f13; --panel:#111526; --panel2:#161b2a; --text:#e9eef6; --muted:#9aa4b2;
  --accent:#D4AF37; --border:rgba(255,255,255,.14); --ok:#2ecc71; --warn:#f39c12; --err:#e74c3c;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0d12,#0f1320);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.hidden{position:absolute;left:-9999px}

/* Top bar */
.topbar{position:sticky;top:0;z-index:50;background:rgba(15,17,25,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.toprow{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:30px;height:30px;border-radius:8px;background:var(--accent);color:#000;display:grid;place-items:center;font-weight:900}
.title{font-weight:700}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel2);font-size:12px;color:var(--muted)}
.dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
.dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
.hamb{background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}

/* Drawer (hamburger menu) */
.drawer{position:fixed;inset:0 0 0 auto; width:86%; max-width:420px; background:rgba(12,14,20,.9); backdrop-filter:blur(10px);
        transform:translateX(100%); transition:.25s; z-index:60; border-left:1px solid var(--border)}
.drawer.open{transform:translateX(0)}
.drawer .panel{padding:14px}
.section-title{font-size:12px;color:var(--muted);margin:8px 0}

/* Content */
.container{padding:14px 14px 80px} /* bottom space for navbar */
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px}
.card h3{margin:0 0 8px 0}
.note{font-size:12px;color:var(--muted)}
.input,textarea{width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px}
.btn{background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;width:100%}
.btn.inline{width:auto}
.btn.accent{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
.btn.danger{border-color:var(--err);color:var(--err)}

/* Kiosk box */
.kioskbox{display:flex;align-items:center;justify-content:center;min-height:230px;border:2px dashed var(--border);border-radius:14px}
.big{font-size:56px;font-weight:900;color:var(--accent);letter-spacing:1px}

/* Admin list as cards */
.searchbar{display:flex;gap:10px;align-items:center;margin:8px 0}
.cards{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:520px){ .cards{ grid-template-columns:1fr 1fr } }
@media(min-width:900px){ .cards{ grid-template-columns:1fr 1fr 1fr } }
.acard{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
.row{display:flex;gap:8px;align-items:center}
.stack{display:flex;flex-direction:column;gap:8px}
.lbl{font-size:12px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}

/* Camera video invisible mais pr√©sente (iOS) */
#qr-video{width:2px;height:2px;opacity:0;position:fixed;left:0;bottom:0;pointer-events:none}

/* Bottom nav */
.bnav{position:fixed;left:0;right:0;bottom:0;z-index:55;background:rgba(15,17,25,.9);backdrop-filter:blur(10px);border-top:1px solid var(--border)}
.bwrap{display:flex}
.bbtn{flex:1;padding:10px 8px;text-align:center;color:var(--muted);border:none;background:transparent;font-weight:600}
.bbtn.active{color:var(--text);border-top:2px solid var(--accent)}
.bbtn span{display:block;font-size:12px}

/* Floating camera button (extra quick) */
.fab{position:fixed;right:16px;bottom:74px;background:var(--accent);color:#000;border:none;border-radius:999px;padding:12px 14px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:56}
.fab.alt{background:var(--panel2);color:var(--text);border:1px solid var(--border)}
@media(min-width:900px){.fab{bottom:20px}}
</style>
</head>
<body>

<!-- Top bar -->
<header class="topbar">
  <div class="toprow">
    <div class="brand">
      <div class="logo">H</div>
      <div class="title">Hedo Lockers</div>
      <span class="badge"><span class="dot" id="cam-dot"></span><span id="cam-label">Cam√©ra : arr√™t√©e</span></span>
    </div>
    <button id="btn-hamb" class="hamb">‚ò∞</button>
  </div>
</header>

<!-- Drawer (hamburger menu) -->
<aside id="drawer" class="drawer" aria-hidden="true">
  <div class="panel">
    <h3>Actions rapides</h3>
    <div class="section-title">Admin</div>
    <div class="stack">
      <button class="btn" id="drawer-create-001-130">Cr√©er casiers 001 ‚Üí 130</button>
      <button class="btn" id="drawer-export-json">Exporter JSON</button>
      <button class="btn" id="drawer-export-csv">Exporter CSV</button>
      <button class="btn" id="drawer-import-json">Importer JSON (local)</button>
      <button class="btn" id="drawer-import-csv">Importer CSV (local)</button>
    </div>
    <div class="section-title">Cam√©ra & cache</div>
    <div class="stack">
      <button class="btn" id="cam-restart">Relancer cam√©ra</button>
      <button class="btn danger" id="btn-reset">R√©initialiser cache local</button>
    </div>
    <div class="section-title">Compte</div>
    <div class="stack">
      <div class="row">
        <input class="input" id="admin-email" placeholder="email admin" />
        <button class="btn inline" id="btn-login">Connexion (lien)</button>
      </div>
      <button class="btn" id="btn-logout">D√©connexion</button>
      <div class="small"><span id="auth-status">Non connect√©</span> <span id="role-status"></span></div>
    </div>
    <div style="height:12px"></div>
    <button class="btn" id="drawer-close">Fermer</button>
  </div>
</aside>

<!-- Content -->
<main class="container">
  <!-- Kiosk -->
  <section id="view-kiosk">
    <div class="card">
      <h3>√âcran client</h3>
      <p class="note">Scanne un <b>QR</b> avec la cam√©ra (bouton üì∑) ou utilise la <b>douchette USB</b> (mode clavier).</p>
      <input id="hidden-capture" class="hidden" />
      <video id="qr-video" muted playsinline></video>
      <div id="kiosk-box" class="kioskbox">
        <div id="kiosk-content" class="note">Scannez votre bracelet‚Ä¶</div>
      </div>
      <div id="kiosk-error" class="note" style="color:var(--err);margin-top:8px"></div>
    </div>
  </section>

  <!-- Admin -->
  <section id="view-admin" style="display:none">
    <div class="card">
      <h3>Administration</h3>
      <p class="note">Modifier le mapping <b>UID ‚Üî Casier</b>, cr√©er de 001‚Üí130, importer/exporter.</p>

      <div class="searchbar">
        <input class="input" id="search" placeholder="Rechercher (casier, UID)..." />
        <button class="btn inline" id="btn-add-card">Ajouter une ligne</button>
        <button class="btn inline accent" id="btn-create-001-130">001‚Üí130</button>
      </div>

      <div id="cards" class="cards"></div>

      <div class="card" style="margin-top:12px">
        <h3>Import / Export (cache local)</h3>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn inline accent" id="btn-export-json">Exporter JSON</button>
          <button class="btn inline" id="btn-export-csv">Exporter CSV</button>
          <button class="btn inline" id="btn-import-json">Importer JSON</button>
          <button class="btn inline" id="btn-import-csv">Importer CSV</button>
        </div>
        <div style="height:8px"></div>
        <textarea id="import-area" class="input" placeholder='Colle JSON [{"locker":101,"uid":"ABC123"}] ou CSV locker,uid'></textarea>
        <p class="note">Les imports √©crivent dans le <b>cache local</b>. Utilise üíæ pour pousser vers Firestore.</p>
      </div>
    </div>
  </section>
</main>

<!-- Bottom nav -->
<nav class="bnav" role="navigation" aria-label="Navigation principale">
  <div class="bwrap">
    <button id="bnav-kiosk" class="bbtn active">üßæ<span>Kiosk</span></button>
    <button id="bnav-admin" class="bbtn">‚öôÔ∏è<span>Admin</span></button>
    <button id="bnav-tools" class="bbtn" onclick="document.getElementById('btn-hamb').click()">‚ò∞<span>Outils</span></button>
  </div>
</nav>

<!-- Floating camera -->
<button id="fab-camera" class="fab" aria-pressed="false">üì∑ Activer cam√©ra</button>

<!-- ================= SCRIPTS ================= -->
<script type="module">
/* Firebase v9 */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc, getDocs, collection, query, orderBy, where, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZ7M8dUKqcUwa9rDyWEdHEwnFVPlrpCds",
  authDomain: "lockers-26331.firebaseapp.com",
  projectId: "lockers-26331",
  storageBucket: "lockers-26331.firebasestorage.app",
  messagingSenderId: "601816918378",
  appId: "1:601816918378:web:b6045b10b60e7957c19d13"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ===== Views / Nav ===== */
const viewKiosk = document.getElementById("view-kiosk");
const viewAdmin = document.getElementById("view-admin");
const bKiosk = document.getElementById("bnav-kiosk");
const bAdmin = document.getElementById("bnav-admin");
function setView(name){
  const isKiosk = name==="kiosk";
  viewKiosk.style.display = isKiosk ? "block" : "none";
  viewAdmin.style.display  = isKiosk ? "none"  : "block";
  bKiosk.classList.toggle("active", isKiosk);
  bAdmin.classList.toggle("active", !isKiosk);
}
bKiosk.onclick = ()=>setView("kiosk");
bAdmin.onclick = ()=>setView("admin");
setView("kiosk");

/* ===== Drawer ===== */
const drawer = document.getElementById("drawer");
const btnHamb = document.getElementById("btn-hamb");
document.getElementById("drawer-close").onclick = ()=> drawer.classList.remove("open");
btnHamb.onclick = ()=> drawer.classList.toggle("open");

/* ===== State / helpers ===== */
const LS_KEY="hedo_lockers_cache_v3";
let state = { map: [], isAdmin:false, uid:null };
const saveLocal = ()=> localStorage.setItem(LS_KEY, JSON.stringify({map:state.map}));
const loadLocal = ()=> { try{const o=JSON.parse(localStorage.getItem(LS_KEY)||"{}"); if(Array.isArray(o.map)) state.map=o.map;}catch{} };
const normalize = (s)=> (s||"").trim();
const showLocker = (locker)=> document.getElementById("kiosk-content").innerHTML =
  locker ? `<div class="note">Votre casier est le</div><div class="big">#${String(locker).padStart(3,"0")}</div>` : `<span class="note">Aucun casier trouv√©.</span>`;

/* ===== Firestore DAO ===== */
const LOCKERS = () => collection(db,"lockers");
const LOCKER  = (id)=> doc(db,"lockers",String(id));
const ADMINS  = (uid)=> doc(db,"admins",String(uid));

async function dbFetchAll(){
  const qs = await getDocs(query(LOCKERS(), orderBy("locker")));
  return qs.docs.map(d=>({ locker:Number(d.id), ...(d.data()||{}) }));
}
async function dbUpsert(locker, uid){
  await setDoc(LOCKER(locker), { locker:Number(locker), uid: uid || null, updatedAt: serverTimestamp() }, { merge:true });
}
async function dbDelete(locker){ await deleteDoc(LOCKER(locker)); }
async function dbFindByUID(uid){
  const qs = await getDocs(query(LOCKERS(), where("uid","==",uid)));
  if (qs.empty) return null;
  const first = qs.docs[0]; return first.data().locker ?? Number(first.id);
}
async function dbCreateRange001to130(){
  const batch = writeBatch(db);
  for(let n=1;n<=130;n++){
    const id = String(n).padStart(3,"0");
    batch.set(LOCKER(id), { locker:Number(id), uid:null, updatedAt:serverTimestamp() }, { merge:true });
  }
  await batch.commit();
}

/* ===== Realtime ===== */
function startRealtime(){
  onSnapshot(LOCKERS(), snap=>{
    state.map = snap.docs.map(d=>({ locker:Number(d.id), ...(d.data()||{}) }));
    saveLocal(); renderCards();
  });
}

/* ===== Auth ===== */
const emailInput = document.getElementById("admin-email");
const btnLogin = document.getElementById("btn-login");
const btnLogout = document.getElementById("btn-logout");
const authStatus = document.getElementById("auth-status");
const roleStatus = document.getElementById("role-status");

btnLogin.onclick = async ()=>{
  const email = normalize(emailInput.value);
  if(!email) return alert("Entre un email.");
  await sendSignInLinkToEmail(auth, email, { url: window.location.href, handleCodeInApp: true });
  localStorage.setItem("hedo_email", email);
  alert("Lien envoy√© √† " + email);
};
btnLogout.onclick = ()=>signOut(auth);

window.addEventListener("load", async ()=>{
  if (isSignInWithEmailLink(auth, window.location.href)) {
    const saved = localStorage.getItem("hedo_email") || prompt("Email ?");
    await signInWithEmailLink(auth, saved, window.location.href);
    localStorage.removeItem("hedo_email");
  }
});

onAuthStateChanged(auth, async (user)=>{
  authStatus.textContent = user ? `Connect√©: ${user.email}` : "Non connect√©";
  state.uid = user ? user.uid : null;
  state.isAdmin = false;
  if (user){ const d = await getDoc(ADMINS(user.uid)); state.isAdmin = d.exists(); }
  roleStatus.textContent = state.isAdmin ? "‚Ä¢ Admin" : "";
  renderCards();
});

/* ===== Admin as cards ===== */
const cards = document.getElementById("cards");
const search = document.getElementById("search");
function renderCards(){
  const q = (search?.value||"").toLowerCase();
  const rows = state.map.slice().sort((a,b)=>a.locker-b.locker)
    .filter(r=>!q || String(r.locker).includes(q) || (r.uid||"").toLowerCase().includes(q));

  cards.innerHTML="";
  rows.forEach(r=>{
    const card = document.createElement("div");
    card.className = "acard";
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><div class="lbl">Casier</div><input class="input locker" value="${String(r.locker).padStart(3,'0')}" /></div>
        <div style="min-width:140px"><div class="lbl">UID</div><input class="input uid" value="${r.uid||""}" placeholder="Scanner‚Ä¶" /></div>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:6px">
          <button class="btn inline" data-act="scan">Scanner ici</button>
          <button class="btn inline danger" data-act="clear">Vider</button>
        </div>
        <div class="row" style="gap:6px">
          <button class="btn inline accent" data-act="save" ${state.isAdmin?"":"disabled"}>üíæ Enregistrer</button>
          <button class="btn inline danger" data-act="del" ${state.isAdmin?"":"disabled"}>üóëÔ∏è Supprimer</button>
        </div>
      </div>`;
    cards.appendChild(card);

    const lockerEl = card.querySelector(".locker");
    const uidEl = card.querySelector(".uid");

    card.querySelector('[data-act="scan"]').onclick = ()=>{
      uidEl.focus(); uidEl.value="";
      const handler=(e)=>{ if(e.key==="Enter"){ uidEl.value = normalize(uidEl.value); document.removeEventListener("keydown",handler,true);} };
      document.addEventListener("keydown", handler, true);
    };
    card.querySelector('[data-act="clear"]').onclick = ()=>{ uidEl.value=""; };

    card.querySelector('[data-act="save"]').onclick = async ()=>{
      if(!state.isAdmin) return alert("R√©serv√© aux admins.");
      const L = Number(lockerEl.value);
      const U = normalize(uidEl.value) || null;
      if(!L) return alert("Num√©ro de casier invalide.");
      try{ await dbUpsert(L, U); }catch(e){ alert("Erreur: "+(e.message||e)); }
    };
    card.querySelector('[data-act="del"]').onclick = async ()=>{
      if(!state.isAdmin) return alert("R√©serv√© aux admins.");
      if(!confirm("Supprimer cette ligne ?")) return;
      try{ await dbDelete(Number(lockerEl.value)); }catch(e){ alert("Erreur: "+(e.message||e)); }
    };
  });
}
search?.addEventListener("input", renderCards);

document.getElementById("btn-add-card").onclick = ()=>{
  state.map.push({ locker:0, uid:"" }); renderCards();
};
document.getElementById("btn-create-001-130").onclick = async ()=>{
  if(!state.isAdmin) return alert("R√©serv√© aux admins.");
  if(!confirm("Cr√©er/mettre √† jour les casiers 001 ‚Üí 130 (UID vides) ?")) return;
  try{ await dbCreateRange001to130(); alert("Casiers 001‚Üí130 cr√©√©s/rafra√Æchis."); }catch(e){ alert("Erreur: "+(e.message||e)); }
};

/* ===== Import / Export (local cache) & Drawer binds ===== */
const area = document.getElementById("import-area");
function downloadText(filename, text){
  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}
function exportJSON(){ downloadText("hedo-lockers.json", JSON.stringify(state.map,null,2)); }
function exportCSV(){
  const rows=[["locker","uid"],...state.map.map(r=>[r.locker,r.uid||""])];
  const csv=rows.map(r=>r.map(c=>String(c).replace(/"/g,'""')).join(",")).join("\n");
  downloadText("hedo-lockers.csv", csv);
}
function importJSON(){
  try{ const arr=JSON.parse(area.value); if(!Array.isArray(arr)) throw new Error("JSON invalide");
    state.map=arr.map(o=>({locker:Number(o.locker),uid:normalize(o.uid||"")})).filter(o=>o.locker);
    saveLocal(); renderCards(); alert("Import local OK");
  }catch(e){ alert("Erreur: "+e.message); }
}
function importCSV(){
  try{ const lines=area.value.trim().split(/\r?\n/); const out=[];
    for(let i=0;i<lines.length;i++){ const line=lines[i].trim(); if(!line)continue;
      const parts=line.split(","); if(i===0 && /locker/i.test(parts[0])) continue;
      const locker=Number(parts[0]); const uid=normalize(parts[1]||""); if(locker) out.push({locker,uid});
    }
    state.map=out; saveLocal(); renderCards(); alert("Import local OK");
  }catch(e){ alert("Erreur: "+e.message); }
}
document.getElementById("btn-export-json").onclick = exportJSON;
document.getElementById("btn-export-csv").onclick = exportCSV;
document.getElementById("btn-import-json").onclick = importJSON;
document.getElementById("btn-import-csv").onclick = importCSV;
/* Drawer shortcuts */
document.getElementById("drawer-export-json").onclick = exportJSON;
document.getElementById("drawer-export-csv").onclick = exportCSV;
document.getElementById("drawer-import-json").onclick = importJSON;
document.getElementById("drawer-import-csv").onclick = importCSV;
document.getElementById("drawer-create-001-130").onclick = async ()=>{
  if(!state.isAdmin) return alert("R√©serv√© aux admins.");
  if(!confirm("Cr√©er/mettre √† jour les casiers 001 ‚Üí 130 ?")) return;
  try{ await dbCreateRange001to130(); alert("OK"); }catch(e){ alert("Erreur: "+(e.message||e)); }
};

/* ===== Kiosk ‚Äì scan clavier ===== */
const hiddenInput = document.getElementById("hidden-capture");
const kioskBox = document.getElementById("kiosk-box");
let buffer="";
function focusCapture(){ hiddenInput.focus(); }
hiddenInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ const data=buffer; buffer=""; onScan(data); }
  else if(e.key.length===1){ buffer+=e.key; }
  else if(e.key==="Backspace"){ buffer=buffer.slice(0,-1); }
});
document.addEventListener("click",(e)=>{ if(viewKiosk.contains(e.target)) setTimeout(focusCapture,0); });
focusCapture();

async function onScan(raw){
  const token = normalize(raw);
  if(!token || token.length<3) return;
  const row = state.map.find(r => (r.uid||"") === token);
  if (row){ showLocker(row.locker); return; }
  try{ const locker = await dbFindByUID(token); showLocker(locker); }catch{ showLocker(null); }
}

/* ===== Cam√©ra iOS18 ‚Äî warm-up + ZXing ===== */
const video = document.getElementById("qr-video");
const camDot = document.getElementById("cam-dot");
const camLabel = document.getElementById("cam-label");
const fabCamera = document.getElementById("fab-camera");
const camRestartBtn = document.getElementById("cam-restart");

let cameraRunning=false, zxingReader=null, zxingControls=null;
function setCamStatus(kind,msg){
  camDot.className="dot "+(kind||"warn"); camLabel.textContent="Cam√©ra : "+(msg||"");
  if (cameraRunning){ fabCamera.textContent="‚èπÔ∏è Arr√™ter cam√©ra"; fabCamera.classList.add("alt"); fabCamera.setAttribute("aria-pressed","true"); }
  else { fabCamera.textContent="üì∑ Activer cam√©ra"; fabCamera.classList.remove("alt"); fabCamera.setAttribute("aria-pressed","false"); }
}
function showCamError(e){
  const name=e?.name||"", msg=e?.message||String(e), framed=(window.top!==window.self);
  let extra=""; if(/NotAllowed|denied|Permission/i.test(name+msg)) extra=" ‚Ä¢ R√©glages > Safari > Appareil photo : ‚ÄòDemander‚Äô.";
  if(framed) extra+=" ‚Ä¢ Si int√©gr√© dans Wix, utiliser ‚ÄúSite externe (URL)‚Äù avec allow=\"camera\".";
  document.getElementById("kiosk-error").textContent = `Cam√©ra indisponible (${name||"Erreur"}): ${msg}${extra}`;
  setCamStatus("err","erreur");
}
async function requestCameraPermission(){
  const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:"environment" } }, audio:false });
  s.getTracks().forEach(t=>t.stop());
}
async function startZXing(){
  const hasBrowser = !!(window.ZXingBrowser && window.ZXingBrowser.BrowserMultiFormatReader);
  if(!hasBrowser) throw new Error("ZXing non charg√©.");
  const { BrowserMultiFormatReader } = window.ZXingBrowser;
  zxingReader = new BrowserMultiFormatReader();
  const onResult = (result)=>{ if(result?.getText){ const text=result.getText(); if(text){ onScan(text); if(navigator.vibrate) navigator.vibrate(60); } } };
  zxingControls = await zxingReader.decodeFromConstraints({ video:{ facingMode:{ ideal:"environment" } } }, video, onResult);
  const stream = video.srcObject;
  if(stream){ stream.getVideoTracks().forEach(tr => tr.onended = ()=>{ cameraRunning=false; setCamStatus("warn","arr√™t√©e"); }); }
}
async function stopCamera(){
  try{ if(zxingControls?.stop) zxingControls.stop(); if(zxingReader?.reset) zxingReader.reset(); }catch{}
  const s=video.srcObject; if(s){ s.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
  zxingReader=null; zxingControls=null; cameraRunning=false; setCamStatus("warn","arr√™t√©e");
}
async function startCamera(){
  try{ setCamStatus("warn","permission‚Ä¶"); await requestCameraPermission();
       setCamStatus("warn","d√©marrage‚Ä¶"); await startZXing();
       cameraRunning=true; setCamStatus("ok","op√©rationnelle"); }
  catch(e){ cameraRunning=false; showCamError(e); }
}
fabCamera.onclick = async ()=>{ if(cameraRunning) await stopCamera(); else await startCamera(); };
camRestartBtn.onclick = ()=>{ if(cameraRunning) stopCamera().then(startCamera); else startCamera(); };

/* ===== Reset local ===== */
document.getElementById("btn-reset").onclick = ()=>{
  if(!confirm("R√©initialiser le cache local ?")) return;
  localStorage.removeItem(LS_KEY);
  state.map=[]; renderCards();
  document.getElementById("kiosk-content").textContent="Scannez votre bracelet‚Ä¶";
  document.getElementById("kiosk-error").textContent="";
};

/* ===== Boot ===== */
loadLocal(); renderCards(); startRealtime();
</script>

<!-- SW registration -->
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  });
}
</script>
</body>
</html>