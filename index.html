<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Hedo Lockers</title>

<!-- PWA -->
<meta name="theme-color" content="#0d0f13" />
<link rel="manifest" href="manifest.webmanifest" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />


<!-- Fallback QR decoder -->
<script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
:root{
  --bg:#0d0f13; --panel:#111526; --panel2:#161b2a; --text:#e9eef6; --muted:#9aa4b2;
  --accent:#D4AF37; --border:rgba(255,255,255,.14); --ok:#2ecc71; --warn:#f39c12; --err:#e74c3c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:linear-gradient(180deg,#0b0d12,#0f1320);color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  padding-top: env(safe-area-inset-top); padding-bottom: calc(env(safe-area-inset-bottom) + 0px);
}
.hidden{position:absolute;left:-9999px}

/* Top bar (safe-area) */
.topbar{position:sticky;top:0;z-index:50;background:rgba(15,17,25,.88);backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border); padding-top: env(safe-area-inset-top)}
.toprow{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:30px;height:30px;border-radius:8px;background:var(--accent);color:#000;display:grid;place-items:center;font-weight:900}
.title{font-weight:700}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel2);font-size:12px;color:var(--muted)}
.dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
.dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
.hamb{background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}

/* Drawer (hamburger menu) */
.drawer{position:fixed;inset:0 0 0 auto;width:86%;max-width:420px;background:rgba(12,14,20,.94);backdrop-filter:blur(10px);
        transform:translateX(100%);transition:.25s;z-index:60;border-left:1px solid var(--border);
        padding-bottom: calc(env(safe-area-inset-bottom) + 12px)}
.drawer.open{transform:translateX(0)}
.drawer .panel{padding:14px}
.section-title{font-size:12px;color:var(--muted);margin:8px 0}

/* Content */
.container{padding:14px 14px calc(80px + env(safe-area-inset-bottom))}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px}
.card h3{margin:0 0 8px 0}
.note{font-size:12px;color:var(--muted)}
.input,textarea{width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px}
.btn{background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
.btn.block{width:100%}
.btn.inline{width:auto}
.btn.accent{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
.btn.danger{border-color:var(--err);color:var(--err)}
.btn.ghost{background:transparent;border:1px dashed var(--border)}
.btn[disabled]{opacity:.6;cursor:not-allowed}

/* Kiosk box */
.kioskbox{display:flex;align-items:center;justify-content:center;min-height:230px;border:2px dashed var(--border);border-radius:14px}
.big{font-size:56px;font-weight:900;color:var(--accent);letter-spacing:1px}

/* Admin list as cards */
.searchbar{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
.cards{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:520px){ .cards{ grid-template-columns:1fr 1fr } }
@media(min-width:900px){ .cards{ grid-template-columns:1fr 1fr 1fr } }
.acard{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.stack{display:flex;flex-direction:column;gap:8px}
.lbl{font-size:12px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}

/* QR video: doit √™tre rendu (iOS) : hors √©cran mais dimensions r√©elles */
#qr-video{
  position:fixed; left:-9999px; top:auto;
  width:160px; height:120px; opacity:0.01;
  pointer-events:none; z-index:-1;
}

/* Bottom nav (safe-area) */
.bnav{position:fixed;left:0;right:0;bottom:0;z-index:55;background:rgba(15,17,25,.92);backdrop-filter:blur(10px);border-top:1px solid var(--border);
  padding-bottom: env(safe-area-inset-bottom)}
.bwrap{display:flex}
.bbtn{flex:1;padding:10px 8px;text-align:center;color:var(--muted);border:none;background:transparent;font-weight:600}
.bbtn.active{color:var(--text);border-top:2px solid var(--accent)}
.bbtn span{display:block;font-size:12px}

/* Floating camera */
.fab{position:fixed;right:16px;bottom:calc(74px + env(safe-area-inset-bottom));background:var(--accent);color:#000;border:none;border-radius:999px;padding:12px 14px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:56}
.fab.alt{background:var(--panel2);color:var(--text);border:1px solid var(--border)}
@media(min-width:900px){.fab{bottom:20px}}

/* Auth visibility helpers */
[data-authonly]{display:none}
[data-authonly].show{display:initial}
</style>
</head>
<body>

<!-- Top bar -->
<header class="topbar">
  <div class="toprow">
    <div class="brand">
      <div class="logo">H</div>
      <div class="title">Hedo Lockers</div>
      <span class="badge"><span class="dot" id="cam-dot"></span><span id="cam-label">Cam√©ra : arr√™t√©e</span></span>
    </div>
    <button id="btn-hamb" class="hamb" aria-label="Ouvrir le menu">‚ò∞</button>
  </div>
</header>

<!-- Drawer -->
<aside id="drawer" class="drawer" aria-hidden="true">
  <div class="panel">
    <h3>Actions & Compte</h3>

    <div class="section-title">Connexion</div>
    <div class="stack">
      <input class="input" id="admin-email" placeholder="email" autocomplete="username" />
      <input class="input" id="admin-pass" type="password" placeholder="mot de passe" autocomplete="current-password" />
      <div class="row" style="gap:8px">
        <button class="btn inline" id="btn-login">Connexion</button>
        <button class="btn inline" id="btn-logout">D√©connexion</button>
      </div>
      <div class="small"><span id="auth-status">Non connect√©</span> <span id="role-status"></span></div>
    </div>

    <div class="section-title">Outils</div>
    <div class="stack" data-authonly>
      <button class="btn" id="drawer-create-001-130" title="√âcriture en base (admin requis)">Cr√©er casiers 001 ‚Üí 130</button>
      <button class="btn" id="drawer-export-json">Exporter JSON</button>
      <button class="btn" id="drawer-export-csv">Exporter CSV</button>
      <button class="btn" id="drawer-import-json">Importer JSON (local)</button>
      <button class="btn" id="drawer-import-csv">Importer CSV (local)</button>
    </div>

    <div class="section-title">Cam√©ra & cache</div>
    <div class="stack">
      <button class="btn" id="cam-restart">Relancer cam√©ra</button>
      <button class="btn danger" id="btn-reset">R√©initialiser cache local</button>
    </div>

    <div style="height:12px"></div>
    <button class="btn block" id="drawer-close">Fermer</button>
  </div>
</aside>

<!-- Content -->
<main class="container">
  <!-- Kiosk -->
  <section id="view-kiosk">
    <div class="card">
      <h3>√âcran client</h3>
      <p class="note">Scanne un <b>QR</b> avec la cam√©ra (bouton üì∑) ou utilise la <b>douchette USB</b> (mode clavier).</p>
      <input id="hidden-capture" class="hidden" />
      <video id="qr-video" muted playsinline></video>
      <div id="kiosk-box" class="kioskbox">
        <div id="kiosk-content" class="note">Scannez votre bracelet‚Ä¶</div>
      </div>
      <div id="kiosk-error" class="note" style="color:var(--err);margin-top:8px"></div>
    </div>
  </section>

  <!-- Admin -->
  <section id="view-admin" style="display:none">
    <div class="card">
      <h3>Administration</h3>
      <p class="note">√âdite le mapping <b>UID ‚Üî Casier</b>. En base (Firestore) : <b>admins</b> uniquement.</p>

      <div class="searchbar">
        <input class="input" id="search" placeholder="Rechercher (casier, UID)..." />
        <button class="btn inline" id="btn-add-card" data-authonly>Ajouter une ligne (locale)</button>
        <button class="btn inline accent" id="btn-create-001-130" data-authonly title="√âcriture en base (admin requis)">Cr√©er 001 ‚Üí 130</button>
      </div>

      <div id="cards" class="cards"></div>

      <div class="card" style="margin-top:12px" data-authonly>
        <h3>Import / Export (cache local)</h3>
        <div class="row" style="gap:8px">
          <button class="btn inline accent" id="btn-export-json">Exporter JSON</button>
          <button class="btn inline" id="btn-export-csv">Exporter CSV</button>
          <button class="btn inline" id="btn-import-json">Importer JSON</button>
          <button class="btn inline" id="btn-import-csv">Importer CSV</button>
        </div>
        <div style="height:8px"></div>
        <textarea id="import-area" class="input" placeholder='Colle JSON [{"locker":101,"uid":"ABC123"}] ou CSV locker,uid'></textarea>
        <p class="note">Les imports modifient le <b>cache local</b>. Utilise üíæ pour pousser vers Firestore (admin requis).</p>
      </div>
    </div>
  </section>
</main>

<!-- Bottom nav -->
<nav class="bnav" role="navigation" aria-label="Navigation principale">
  <div class="bwrap">
    <button id="bnav-kiosk" class="bbtn active">üßæ<span>Kiosk</span></button>
    <button id="bnav-admin" class="bbtn">‚öôÔ∏è<span>Admin</span></button>
    <button id="bnav-tools" class="bbtn" onclick="document.getElementById('btn-hamb').click()">‚ò∞<span>Outils</span></button>
  </div>
</nav>

<!-- Floating camera -->
<button id="fab-camera" class="fab" aria-pressed="false">üì∑ Activer cam√©ra</button>

<!-- ================= SCRIPTS ================= -->
<script type="module">
/* Firebase v9 */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc, getDocs, collection, query, orderBy, where, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZ7M8dUKqcUwa9rDyWEdHEwnFVPlrpCds",
  authDomain: "lockers-26331.firebaseapp.com",
  projectId: "lockers-26331",
  storageBucket: "lockers-26331.firebasestorage.app",
  messagingSenderId: "601816918378",
  appId: "1:601816918378:web:b6045b10b60e7957c19d13"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ===== Views / Nav ===== */
const viewKiosk = document.getElementById("view-kiosk");
const viewAdmin = document.getElementById("view-admin");
const bKiosk = document.getElementById("bnav-kiosk");
const bAdmin = document.getElementById("bnav-admin");
function setView(name){
  const isKiosk = name==="kiosk";
  viewKiosk.style.display = isKiosk ? "block" : "none";
  viewAdmin.style.display  = isKiosk ? "none"  : "block";
  bKiosk.classList.toggle("active", isKiosk);
  bAdmin.classList.toggle("active", !isKiosk);
}
bKiosk.onclick = ()=>setView("kiosk");
bAdmin.onclick = ()=>setView("admin");
setView("kiosk");

/* ===== Drawer ===== */
const drawer = document.getElementById("drawer");
const btnHamb = document.getElementById("btn-hamb");
document.getElementById("drawer-close").onclick = ()=> drawer.classList.remove("open");
btnHamb.onclick = ()=> drawer.classList.toggle("open");

/* ===== State / helpers ===== */
const LS_KEY="hedo_lockers_cache_v7";
let state = { map: [], isAuthed:false, isAdmin:false, uid:null };
const saveLocal = ()=> localStorage.setItem(LS_KEY, JSON.stringify({map:state.map}));
const loadLocal = ()=> { try{const o=JSON.parse(localStorage.getItem(LS_KEY)||"{}"); if(Array.isArray(o.map)) state.map=o.map;}catch{} };
const normalize = (s)=> (s||"").trim();
const showLocker = (locker)=> document.getElementById("kiosk-content").innerHTML =
  locker ? `<div class="note">Votre casier est le</div><div class="big">#${String(locker).padStart(3,"0")}</div>` : `<span class="note">Aucun casier trouv√©.</span>`;

/* PATCH visibility: show tools after login */
function setAuthUI(isAuthed){
  document.querySelectorAll("[data-authonly]").forEach(el=>{
    el.classList.toggle("show", !!isAuthed);
  });
}

/* ===== Firestore DAO ===== */
const LOCKERS = () => collection(db,"lockers");
const LOCKER  = (id)=> doc(db,"lockers",String(id));
const ADMINS  = (uid)=> doc(db,"admins",String(uid));
const padId = (n)=> {
  const num = Number(n);
  if (Number.isNaN(num) || num < 0) return String(n||"");
  // Canonique sur 3 chiffres (001..999). Ajuste si tu veux 4 chiffres.
  return String(num).padStart(3,"0");
};

async function dbUpsert(locker, uid){
  // ID doc canonique pour √©viter les doublons "1" vs "001"
  const id = padId(locker);
  await setDoc(LOCKER(id), { locker:Number(locker), uid: uid || null, updatedAt: serverTimestamp() }, { merge:true });
}
async function dbDelete(locker){
  const id = padId(locker);
  await deleteDoc(LOCKER(id));
}
async function dbFindByUID(uid){
  const qs = await getDocs(query(LOCKERS(), where("uid","==",uid)));
  if (qs.empty) return null;
  const first = qs.docs[0]; return first.data().locker ?? Number(first.id);
}

/* ===== Realtime ===== */
function startRealtime(){
  onSnapshot(query(LOCKERS(), orderBy("locker")), snap=>{
    state.map = snap.docs.map(d=>({ locker:Number((d.data()?.locker) ?? d.id), ...(d.data()||{}) }));
    saveLocal(); renderCards();
  });
}

/* ===== Auth (email + mot de passe) ===== */
const emailInput = document.getElementById("admin-email");
const passInput  = document.getElementById("admin-pass");
const btnLogin   = document.getElementById("btn-login");
const btnLogout  = document.getElementById("btn-logout");
const authStatus = document.getElementById("auth-status");
const roleStatus = document.getElementById("role-status");

btnLogin.onclick = async ()=>{
  try{
    const email = normalize(emailInput.value);
    const pass  = normalize(passInput.value);
    if(!email || !pass) return alert("Email et mot de passe requis.");
    await signInWithEmailAndPassword(auth, email, pass);
    drawer.classList.remove("open");
  }catch(e){
    alert("Erreur connexion : " + (e.message || e));
  }
};
btnLogout.onclick = ()=> signOut(auth);

onAuthStateChanged(auth, async (user)=>{
  authStatus.textContent = user ? `Connect√©: ${user.email}` : "Non connect√©";
  state.uid = user ? user.uid : null;
  state.isAuthed = !!user;
  state.isAdmin = false;
  if (user){
    const d = await getDoc(ADMINS(user.uid));
    state.isAdmin = d.exists();
  }
  roleStatus.textContent = state.isAdmin ? "‚Ä¢ Admin" : "";
  setAuthUI(state.isAuthed);
  renderCards();
});

/* ===== Admin as cards (scan + save/delete corrects) ===== */
const cards = document.getElementById("cards");
const search = document.getElementById("search");
let scanTargetInput = null; // si d√©fini, le prochain QR d√©cod√© remplit cet input puis stoppe la cam√©ra

function renderCards(){
  const q = (search?.value||"").toLowerCase();
  const rows = state.map.slice().sort((a,b)=>a.locker-b.locker)
    .filter(r=>!q || String(r.locker).includes(q) || (r.uid||"").toLowerCase().includes(q));

  cards.innerHTML="";
  rows.forEach(r=>{
    const card = document.createElement("div");
    card.className = "acard";
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;gap:12px">
        <div style="flex:0 0 120px">
          <div class="lbl">Casier</div>
          <input class="input locker" value="${String(r.locker).padStart(3,'0')}" ${state.isAuthed?"":"disabled"} />
        </div>
        <div style="flex:1">
          <div class="lbl">UID</div>
          <input class="input uid" value="${r.uid||""}" placeholder="${state.isAuthed?'Scanner‚Ä¶ (clavier ou üì∑)':'Connecte-toi pour √©diter'}" ${state.isAuthed?"":"disabled"} />
        </div>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:6px">
          <button class="btn inline" data-act="scan-kb" ${state.isAuthed?"":"disabled"}>Scanner (clavier)</button>
          <button class="btn inline" data-act="scan-cam" ${state.isAuthed?"":"disabled"}>üì∑ Scanner (cam√©ra)</button>
          <button class="btn inline ghost" data-act="clear" ${state.isAuthed?"":"disabled"}>Vider UID</button>
        </div>
        <div class="row" style="gap:6px">
          <button class="btn inline accent" data-act="save" ${state.isAuthed?"":"disabled"} title="${state.isAdmin?'':'√âcriture en base = admin'}">üíæ Enregistrer</button>
          <button class="btn inline danger" data-act="del" ${state.isAuthed?"":"disabled"} title="${state.isAdmin?'':'Suppression en base = admin'}">üóëÔ∏è Supprimer</button>
          <button class="btn inline" data-act="remove-local" ${state.isAuthed && !state.isAdmin ? "" : "style='display:none'"}>üßπ Retirer (local)</button>
        </div>
      </div>`;
    cards.appendChild(card);

    const lockerEl = card.querySelector(".locker");
    const uidEl = card.querySelector(".uid");

    // Scanner clavier (douchette)
    card.querySelector('[data-act="scan-kb"]').onclick = ()=>{
      if(!state.isAuthed) return alert("Connecte-toi pour utiliser cet outil.");
      uidEl.focus(); uidEl.value="";
      const handler=(e)=>{ if(e.key==="Enter"){ uidEl.value = normalize(uidEl.value); document.removeEventListener("keydown",handler,true);} };
      document.addEventListener("keydown", handler, true);
    };

    // Scanner cam√©ra ‚Üí remplit l'UID de cette carte
    card.querySelector('[data-act="scan-cam"]').onclick = async ()=>{
      if(!state.isAuthed) return alert("Connecte-toi pour utiliser cet outil.");
      scanTargetInput = uidEl;
      if(!cameraRunning) await startCamera(); // lance la cam√©ra si n√©cessaire
    };

    // Vider UID
    card.querySelector('[data-act="clear"]').onclick = ()=>{ if(state.isAuthed) uidEl.value=""; };

    // Enregistrer (upsert) ‚Äî pas de doublon gr√¢ce √† padId()
    card.querySelector('[data-act="save"]').onclick = async ()=>{
      if(!state.isAuthed) return alert("Connecte-toi d‚Äôabord.");
      if(!state.isAdmin) return alert("√âcriture en base r√©serv√©e aux admins.");
      const Lraw = lockerEl.value; const Lnum = Number(Lraw);
      if(!Lnum) return alert("Num√©ro de casier invalide.");
      const U = normalize(uidEl.value) || null;
      try{ await dbUpsert(Lnum, U); }catch(e){ alert("Erreur: "+(e.message||e)); }
    };

    // Supprimer (base) ‚Äî admin
    card.querySelector('[data-act="del"]').onclick = async ()=>{
      if(!state.isAuthed) return alert("Connecte-toi d‚Äôabord.");
      if(!state.isAdmin) return alert("Suppression en base r√©serv√©e aux admins. Utilise ‚ÄòRetirer (local)‚Äô.");
      if(!confirm("Supprimer ce casier en base ?")) return;
      try{ await dbDelete(Number(lockerEl.value)); }catch(e){ alert("Erreur: "+(e.message||e)); }
    };

    // Retirer (local) ‚Äî pour les non-admins : enl√®ve de la vue (cache local), sans toucher la base
    const removeLocalBtn = card.querySelector('[data-act="remove-local"]');
    if (removeLocalBtn){
      removeLocalBtn.onclick = ()=>{
        const Lnum = Number(lockerEl.value);
        state.map = state.map.filter(x => Number(x.locker)!==Lnum);
        saveLocal(); renderCards();
        alert("Ligne retir√©e localement (non persist√©e).");
      };
    }
  });
}
search?.addEventListener("input", renderCards);

document.getElementById("btn-add-card").onclick = ()=>{
  if(!state.isAuthed) return alert("Connecte-toi d‚Äôabord.");
  // Ajout local uniquement ; l'enregistrement poussera en base si admin
  state.map.push({ locker:0, uid:"" }); saveLocal(); renderCards();
};
document.getElementById("btn-create-001-130").onclick = async ()=>{
  if(!state.isAuthed) return alert("Connecte-toi d‚Äôabord.");
  if(!state.isAdmin) return alert("Cr√©ation en base r√©serv√©e aux admins.");
  if(!confirm("Cr√©er/mettre √† jour les casiers 001 ‚Üí 130 (UID vides) ?")) return;
  try{
    const batch = writeBatch(db);
    for(let n=1;n<=130;n++){
      const id = padId(n);
      batch.set(LOCKER(id), { locker:n, uid:null, updatedAt:serverTimestamp() }, { merge:true });
    }
    await batch.commit();
    alert("Casiers 001‚Üí130 cr√©√©s/rafra√Æchis.");
  }catch(e){ alert("Erreur: "+(e.message||e)); }
};
/* Drawer shortcuts */
document.getElementById("drawer-create-001-130").onclick = ()=> document.getElementById("btn-create-001-130").click();

/* ===== Import / Export (local cache) ===== */
const area = document.getElementById("import-area");
function downloadText(filename, text){
  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}
function mustAuth(){ if(!state.isAuthed){ alert("Connecte-toi d‚Äôabord."); return true; } return false; }
function exportJSON(){ if(mustAuth()) return; downloadText("hedo-lockers.json", JSON.stringify(state.map,null,2)); }
function exportCSV(){
  if(mustAuth()) return;
  const rows=[["locker","uid"],...state.map.map(r=>[r.locker,r.uid||""])];
  const csv=rows.map(r=>r.map(c=>String(c).replace(/"/g,'""')).join(",")).join("\n");
  downloadText("hedo-lockers.csv", csv);
}
function importJSON(){
  if(mustAuth()) return;
  try{ const arr=JSON.parse(area.value); if(!Array.isArray(arr)) throw new Error("JSON invalide");
    state.map=arr.map(o=>({locker:Number(o.locker),uid:normalize(o.uid||"")})).filter(o=>o.locker);
    saveLocal(); renderCards(); alert("Import local OK");
  }catch(e){ alert("Erreur: "+e.message); }
}
function importCSV(){
  if(mustAuth()) return;
  try{ const lines=area.value.trim().split(/\r?\n/); const out=[];
    for(let i=0;i<lines.length;i++){ const line=lines[i].trim(); if(!line)continue;
      const parts=line.split(","); if(i===0 && /locker/i.test(parts[0])) continue;
      const locker=Number(parts[0]); const uid=normalize(parts[1]||""); if(locker) out.push({locker,uid});
    }
    state.map=out; saveLocal(); renderCards(); alert("Import local OK");
  }catch(e){ alert("Erreur: "+e.message); }
}
document.getElementById("btn-export-json").onclick = exportJSON;
document.getElementById("btn-export-csv").onclick = exportCSV;
document.getElementById("btn-import-json").onclick = importJSON;
document.getElementById("btn-import-csv").onclick = importCSV;
document.getElementById("drawer-export-json").onclick = exportJSON;
document.getElementById("drawer-export-csv").onclick = exportCSV;
document.getElementById("drawer-import-json").onclick = importJSON;
document.getElementById("drawer-import-csv").onclick = importCSV;

/* ===== Kiosk ‚Äì scan clavier ===== */
const hiddenInput = document.getElementById("hidden-capture");
let buffer="";
function focusCapture(){ hiddenInput.focus(); }
hiddenInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ const data=buffer; buffer=""; onScan(data); }
  else if(e.key.length===1){ buffer+=e.key; }
  else if(e.key==="Backspace"){ buffer=buffer.slice(0,-1); }
});
document.addEventListener("click",(e)=>{ if(viewKiosk.contains(e.target)) setTimeout(focusCapture,0); });
focusCapture();

async function onScan(raw){
  const token = normalize(raw);
  if(!token || token.length<3) return;

  // Si on vise un champ UID dans l'admin, on le remplit puis on coupe la cam√©ra
  if (scanTargetInput){
    scanTargetInput.value = token;
    if (navigator.vibrate) navigator.vibrate(60);
    // fin du mode cibl√©
    scanTargetInput = null;
    // ne pas afficher sur Kiosk dans ce cas
    await stopCamera();
    return;
  }

  // Sinon, mode Kiosk : affiche le n¬∞ de casier
  const row = state.map.find(r => (r.uid||"") === token);
  if (row){ showLocker(row.locker); return; }
  try{ const locker = await dbFindByUID(token); showLocker(locker); }catch{ showLocker(null); }
}

/* ===== Cam√©ra iOS/Android ‚Äî robuste (BarcodeDetector ‚Üí ZXing ‚Üí jsQR) ===== */
const video = document.getElementById("qr-video");
const camDot = document.getElementById("cam-dot");
const camLabel = document.getElementById("cam-label");
const fabCamera = document.getElementById("fab-camera");
const camRestartBtn = document.getElementById("cam-restart");

let cameraRunning = false;
let stream = null;
let stopDecoder = null;

function setCamStatus(kind,msg){
  camDot.className = "dot " + (kind||"warn");
  camLabel.textContent = "Cam√©ra : " + (msg||"");
  if (cameraRunning){
    fabCamera.textContent="‚èπÔ∏è Arr√™ter cam√©ra";
    fabCamera.classList.add("alt");
    fabCamera.setAttribute("aria-pressed","true");
  } else {
    fabCamera.textContent="üì∑ Activer cam√©ra";
    fabCamera.classList.remove("alt");
    fabCamera.setAttribute("aria-pressed","false");
  }
}
function showCamError(e){
  const name=e?.name||"", msg=e?.message||String(e);
  let extra=" ‚Ä¢ R√©glages > Safari/Chrome ‚Üí Appareil photo : ‚ÄòAutoriser/Demander‚Äô.";
  if (window.top !== window.self) extra += " ‚Ä¢ Dans Wix, mettre allow=\"camera\" sur l‚Äôiframe.";
  document.getElementById("kiosk-error").textContent = `Cam√©ra indisponible (${name||"Erreur"}): ${msg}${extra}`;
  console.error("Camera error:", e);
  setCamStatus("err","erreur");
}

async function ensureZXing(){
  if (window.ZXingBrowser?.BrowserMultiFormatReader) return true;
  const sources = [
    "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js",
    "https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js",
    "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"
  ];
  for (const src of sources){
    try{
      await new Promise((resolve, reject)=>{
        const s=document.createElement("script");
        s.src=src; s.async=true; s.onload=resolve; s.onerror=reject;
        document.head.appendChild(s);
      });
      if (window.ZXingBrowser?.BrowserMultiFormatReader) return true;
    }catch{/* essaye suivant */}
  }
  return false;
}

async function warmUpPermission(){
  const gum = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:{ ideal:"environment" }, width:{ideal:1280}, height:{ideal:720} },
    audio:false
  });
  gum.getTracks().forEach(t=>t.stop());
}

async function startCamera(){
  try{
    setCamStatus("warn","permission‚Ä¶");
    await warmUpPermission();

    setCamStatus("warn","d√©marrage‚Ä¶");
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:"environment" }, width:{ideal:1280}, height:{ideal:720} },
      audio:false
    });
    video.srcObject = stream;
    await video.play();

    // 1) D√©codeur natif
    if ("BarcodeDetector" in window){
      const formats = await (window.BarcodeDetector.getSupportedFormats?.()||[]);
      if (!formats.length || formats.includes("qr_code")){
        stopDecoder = startBarcodeDetectorLoop(video);
        cameraRunning = true; setCamStatus("ok","op√©rationnelle (natif)");
        return;
      }
    }
    // 2) ZXing
    const ok = await ensureZXing();
    if (ok){
      stopDecoder = await startZXing(video);
      cameraRunning = true; setCamStatus("ok","op√©rationnelle (ZXing)");
      return;
    }
    // 3) jsQR
    if (window.jsQR){
      stopDecoder = startJsQRLoop(video);
      cameraRunning = true; setCamStatus("ok","op√©rationnelle (jsQR)");
      return;
    }
    throw new Error("Aucun d√©codeur dispo (BarcodeDetector/ZXing/jsQR).");
  }catch(e){
    cameraRunning = false;
    await stopCamera();
    showCamError(e);
  }
}

async function stopCamera(){
  try{ if (stopDecoder) { stopDecoder(); stopDecoder=null; } }catch{}
  try{ if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch{}
  try{ if (video){ video.pause(); video.srcObject=null; } }catch{}
  cameraRunning=false;
  setCamStatus("warn","arr√™t√©e");
}

function startBarcodeDetectorLoop(videoEl){
  const detector = new window.BarcodeDetector({ formats:["qr_code"] });
  let stopped=false;
  async function tick(){
    if (stopped) return;
    try{
      const res = await detector.detect(videoEl);
      if (res && res.length){
        const txt = res[0].rawValue || res[0].rawValue || "";
        if (txt){ onScan(txt); if (scanTargetInput){ /* si cibl√© ‚Üí stop */ await stopCamera(); } if (navigator.vibrate) navigator.vibrate(60); }
      }
    }catch{}
    finally{ if (!stopped) requestAnimationFrame(tick); }
  }
  requestAnimationFrame(tick);
  return ()=>{ stopped=true; };
}

async function startZXing(videoEl){
  const { BrowserMultiFormatReader } = window.ZXingBrowser || {};
  if (!BrowserMultiFormatReader) throw new Error("ZXing non charg√©");
  const reader = new BrowserMultiFormatReader();
  const controls = await reader.decodeFromConstraints(
    { video:{ facingMode:{ ideal:"environment" } } },
    videoEl,
    async (result)=>{ if(result?.getText){ const t=result.getText(); if(t){ onScan(t); if (scanTargetInput){ await stopCamera(); } if(navigator.vibrate) navigator.vibrate(60); } } }
  );
  return ()=>{ try{ controls.stop(); reader.reset(); }catch{} };
}

function startJsQRLoop(videoEl){
  const cvs=document.createElement("canvas");
  const ctx=cvs.getContext("2d",{willReadFrequently:true});
  let stopped=false;

  function frame(){
    if (stopped) return;
    const w=videoEl.videoWidth||640, h=videoEl.videoHeight||480;
    if (w && h){
      cvs.width=w; cvs.height=h;
      ctx.drawImage(videoEl,0,0,w,h);
      const imgData = ctx.getImageData(0,0,w,h);
      const res = window.jsQR(imgData.data, w, h, { inversionAttempts:"attemptBoth" });
      if (res?.data){
        onScan(res.data);
        if (scanTargetInput){ stopCamera(); }
        if (navigator.vibrate) navigator.vibrate(60);
      }
    }
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
  return ()=>{ stopped=true; };
}

/* Camera buttons */
fabCamera.onclick = async ()=>{ if (cameraRunning) await stopCamera(); else await startCamera(); };
camRestartBtn?.addEventListener("click", ()=>{ if(cameraRunning) stopCamera().then(startCamera); else startCamera(); });

/* Reprise apr√®s retour d‚Äôarri√®re-plan (PWA A2HS) */
document.addEventListener("visibilitychange", ()=>{
  if (document.visibilityState === "visible" && cameraRunning){
    stopCamera().then(startCamera).catch(()=>{});
  }
});

/* ===== Reset local ===== */
document.getElementById("btn-reset").onclick = ()=>{
  if(!confirm("R√©initialiser le cache local ?")) return;
  localStorage.removeItem(LS_KEY);
  state.map=[]; renderCards();
  document.getElementById("kiosk-content").textContent="Scannez votre bracelet‚Ä¶";
  document.getElementById("kiosk-error").textContent="";
};

/* ===== Boot ===== */
loadLocal(); setAuthUI(false); renderCards(); startRealtime();

/* ===== SW ===== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  });
}

/* ===== Standalone detection ===== */
function isStandalone(){
  return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);
}
if (isStandalone()){
  document.body.classList.add("standalone");
}
</script>
</body>
</html>