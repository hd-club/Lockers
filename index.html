<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<!-- Anti-zoom iOS + safe-area -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>Hedo Lockers</title>

<!-- PWA -->
<meta name="theme-color" content="#0d0f13" />
<link rel="manifest" href="manifest.webmanifest" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />

<!-- QR fallback (no ZXing) -->
<script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<!-- SheetJS for Excel/CSV import -->
<script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0d0f13; --panel:#111526; --panel2:#161b2a; --text:#e9eef6; --muted:#9aa4b2;
  --accent:#D4AF37; --border:rgba(255,255,255,.14); --ok:#2ecc71; --warn:#f39c12; --err:#e74c3c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:linear-gradient(180deg,#0b0d12,#0f1320);color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  padding-top: env(safe-area-inset-top); padding-bottom: calc(env(safe-area-inset-bottom) + 0px);
}
.hidden{position:absolute;left:-9999px}

/* Emp√™che le zoom iOS au focus (>=16px) */
input, select, textarea, button { font-size:16px; }
.input { font-size:16px; }
.btn   { font-size:16px; }

/* Top bar */
.topbar{position:sticky;top:0;z-index:50;background:rgba(15,17,25,.88);backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border); padding-top: env(safe-area-inset-top)}
.toprow{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:30px;height:30px;border-radius:8px;background:var(--accent);color:#000;display:grid;place-items:center;font-weight:900}
.title{font-weight:700}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel2);font-size:12px;color:var(--muted)}
.dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
.dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
.hamb{background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}

/* Drawer (descendre un peu le contenu) */
.drawer{position:fixed;inset:0 0 0 auto;width:86%;max-width:420px;background:rgba(12,14,20,.94);backdrop-filter:blur(10px);
        transform:translateX(100%);transition:.25s;z-index:60;border-left:1px solid var(--border);
        padding-bottom: calc(env(safe-area-inset-bottom) + 12px)}
.drawer.open{transform:translateX(0)}
.drawer .panel{padding:28px 14px 14px}
.section-title{font-size:12px;color:var(--muted);margin:16px 0 8px}

/* Content (m√™mes gabarits admin/kiosk) */
.container{padding:14px 14px calc(80px + env(safe-area-inset-bottom)); max-width:900px; margin:0 auto;}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px}
.card h3{margin:0 0 8px 0}
.note{font-size:12px;color:var(--muted)}
.input,textarea{width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px}
.btn{background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
.btn.block{width:100%}
.btn.inline{width:auto}
.btn.accent{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
.btn.danger{border-color:var(--err);color:var(--err)}
.btn.ghost{background:transparent;border:1px dashed var(--border)}
.btn[disabled]{opacity:.6;cursor:not-allowed}

/* Kiosk align√© au design iPhone */
.kioskbox{display:flex;align-items:center;justify-content:center;min-height:280px;border:2px dashed var(--border);border-radius:14px}
.big{font-size:56px;font-weight:900;color:var(--accent);letter-spacing:1px; line-height:1.05}

/* Admin list */
.searchbar{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
.cards{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:520px){ .cards{ grid-template-columns:1fr 1fr } }
@media(min-width:900px){ .cards{ grid-template-columns:1fr 1fr 1fr } }
.acard{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.stack{display:flex;flex-direction:column;gap:8px}
.lbl{font-size:12px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}

/* QR video: rendu requis (iOS) : hors √©cran mais dimensions r√©elles */
#qr-video{
  position:fixed; left:-9999px; top:auto;
  width:160px; height:120px; opacity:0.01;
  pointer-events:none; z-index:-1;
}

/* Bottom nav */
.bnav{position:fixed;left:0;right:0;bottom:0;z-index:55;background:rgba(15,17,25,.92);backdrop-filter:blur(10px);border-top:1px solid var(--border);
  padding-bottom: env(safe-area-inset-bottom)}
.bwrap{display:flex}
.bbtn{flex:1;padding:10px 8px;text-align:center;color:var(--muted);border:none;background:transparent;font-weight:600}
.bbtn.active{color:var(--text);border-top:2px solid var(--accent)}
.bbtn span{display:block;font-size:12px}

/* Floating camera */
.fab{position:fixed;right:16px;bottom:calc(74px + env(safe-area-inset-bottom));background:var(--accent);color:#000;border:none;border-radius:999px;padding:12px 14px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:56}
.fab.alt{background:var(--panel2);color:var(--text);border:1px solid var(--border)}
@media(min-width:900px){.fab{bottom:20px}}

/* Auth visibility */
[data-authonly]{display:none}
[data-authonly].show{display:initial}
</style>
</head>
<body>

<!-- Top bar -->
<header class="topbar">
  <div class="toprow">
    <div class="brand">
      <div class="logo">H</div>
      <div class="title">Hedo Lockers</div>
      <span class="badge"><span class="dot" id="cam-dot"></span><span id="cam-label">Cam√©ra : arr√™t√©e</span></span>
    </div>
    <button id="btn-hamb" class="hamb" aria-label="Ouvrir le menu">‚ò∞</button>
  </div>
</header>

<!-- Drawer -->
<aside id="drawer" class="drawer" aria-hidden="true">
  <div class="panel">
    <h3>Actions & Compte</h3>

    <div class="section-title">Connexion</div>
    <div class="stack">
      <input class="input" id="admin-email" placeholder="email" autocomplete="username" />
      <input class="input" id="admin-pass" type="password" placeholder="mot de passe" autocomplete="current-password" />
      <label class="small" style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="remember-me" /> Se souvenir de moi sur cet appareil
      </label>
      <div class="row" style="gap:8px">
        <button class="btn inline" id="btn-login">Connexion</button>
        <button class="btn inline" id="btn-logout">D√©connexion</button>
      </div>
      <div class="small"><span id="auth-status">Non connect√©</span> <span id="role-status"></span></div>
    </div>

    <div class="section-title">Outils</div>
    <div class="stack" data-authonly>
      <button class="btn" id="drawer-create-001-130" title="√âcriture en base (admin requis)">Cr√©er casiers 001 ‚Üí 130</button>
      <button class="btn" id="drawer-export-json">Exporter JSON</button>
      <button class="btn" id="drawer-export-csv">Exporter CSV</button>
      <button class="btn" id="drawer-import-json">Importer JSON (local)</button>
      <button class="btn" id="drawer-import-csv">Importer CSV (local)</button>
      <!-- Import fichier -->
      <button class="btn" id="drawer-import-file">Importer un fichier‚Ä¶</button>
    </div>

    <div class="section-title">Cam√©ra & cache</div>
    <div class="stack">
      <button class="btn" id="cam-restart">Relancer cam√©ra</button>
      <button class="btn danger" id="btn-reset">R√©initialiser cache local</button>
    </div>

    <!-- ===== Nouveau : FORMAT LECTEUR RFID ===== -->
    <div class="section-title">Format lecteur RFID</div>
    <div class="stack">
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input class="input" id="fmt-prefix" placeholder="Pr√©fixe √† retirer (ex: %;STX)" style="flex:1 1 180px" />
        <input class="input" id="fmt-suffix" placeholder="Suffixe √† retirer (ex: ?;ETX)" style="flex:1 1 180px" />
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input class="input" id="fmt-cut-start" type="number" min="0" placeholder="Couper N premiers" style="width:160px" />
        <input class="input" id="fmt-cut-end" type="number" min="0" placeholder="Couper N derniers" style="width:160px" />
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input class="input" id="fmt-delim" placeholder="D√©limiteur (ex: , ; |)" style="flex:1 1 160px" />
        <input class="input" id="fmt-seg-index" type="number" min="0" placeholder="Segment # (0=1er)" style="width:160px" />
      </div>
      <input class="input" id="fmt-regex" placeholder="Regex capture (ex: ^\\d{2}(\\w+)$ ‚Üí groupe 1)" />
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <label class="small"><input type="checkbox" id="fmt-keep-alnum" checked /> Garder A-Z0-9</label>
        <label class="small"><input type="checkbox" id="fmt-upper" checked /> Majuscules</label>
        <label class="small"><input type="checkbox" id="fmt-hex2dec" /> Hex ‚Üí D√©cimal</label>
        <label class="small"><input type="checkbox" id="fmt-dec2hex" /> D√©cimal ‚Üí Hex</label>
        <input class="input" id="fmt-hex-pad" type="number" min="0" placeholder="Hex padding (ex: 8)" style="width:160px" />
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <select class="input" id="fmt-wiegand-mode" style="flex:1 1 180px">
          <option value="off">Wiegand: d√©sactiv√©</option>
          <option value="w26">Wiegand 26 (entr√©e d√©cimale/hex)</option>
          <option value="w34">Wiegand 34 (entr√©e d√©cimale/hex)</option>
        </select>
        <select class="input" id="fmt-wiegand-in" style="flex:1 1 180px">
          <option value="dec">Entr√©e: d√©cimal</option>
          <option value="hex">Entr√©e: hex</option>
        </select>
        <select class="input" id="fmt-wiegand-out" style="flex:1 1 200px">
          <option value="fc-cn">Sortie: FC-CN</option>
          <option value="card">Sortie: CN (card)</option>
          <option value="fc_card">Sortie: FC.CN</option>
        </select>
      </div>
      <input class="input" id="fmt-template" placeholder="Gabarit sortie (ex: {norm} / {hex} / {dec} / {fc}-{cn})" />
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input class="input" id="fmt-test-in" placeholder="Tester avec une valeur lue‚Ä¶" style="flex:1 1 240px" />
        <button class="btn" id="fmt-test-run">Tester</button>
      </div>
      <div class="small">R√©sultat : <code id="fmt-test-out">‚Äî</code></div>
      <div class="row" style="gap:8px">
        <button class="btn" id="fmt-save">üíæ Enregistrer format</button>
        <button class="btn ghost" id="fmt-reset">R√©initialiser</button>
      </div>
    </div>

    <div style="height:12px"></div>
    <button class="btn block" id="drawer-close">Fermer</button>
  </div>
</aside>

<!-- Content -->
<main class="container">
  <!-- Kiosk -->
  <section id="view-kiosk">
    <div class="card">
      <h3>√âcran client</h3>
      <p class="note">Scanne un <b>QR</b> avec la cam√©ra (bouton üì∑) ou utilise la <b>douchette USB</b> (mode clavier).</p>
      <input id="hidden-capture" class="hidden" />
      <video id="qr-video" muted playsinline></video>
      <div id="kiosk-box" class="kioskbox">
        <div id="kiosk-content" class="note">Scannez votre bracelet‚Ä¶</div>
      </div>
      <div id="kiosk-error" class="note" style="color:var(--err);margin-top:8px"></div>
    </div>
  </section>

  <!-- Admin -->
  <section id="view-admin" style="display:none">
    <div class="card">
      <h3>Administration</h3>
      <p class="note">√âdite le mapping <b>UID ‚Üî Casier</b>. En base (Firestore) : <b>admins</b> ou <b>propri√©taire</b> du doc.</p>

      <div class="searchbar">
        <input class="input" id="search" placeholder="Rechercher (casier, UID)..." />
        <button class="btn inline" id="btn-add-card" data-authonly>Ajouter une ligne (locale)</button>
        <button class="btn inline accent" id="btn-create-001-130" data-authonly title="√âcriture en base (admin requis)">Cr√©er 001 ‚Üí 130</button>
      </div>

      <div id="cards" class="cards"></div>

      <div class="card" style="margin-top:12px" data-authonly>
        <h3>Import / Export (cache local)</h3>
        <div class="row" style="gap:8px">
          <button class="btn inline accent" id="btn-export-json">Exporter JSON</button>
          <button class="btn inline" id="btn-export-csv">Exporter CSV</button>
          <button class="btn inline" id="btn-import-json">Importer JSON</button>
          <button class="btn inline" id="btn-import-csv">Importer CSV</button>
          <button class="btn inline" id="btn-import-file">Importer un fichier‚Ä¶</button>
          <input id="file-input" type="file" accept=".csv,.xlsx,.xls,.numbers" class="hidden" />
        </div>
        <div style="height:8px"></div>
        <textarea id="import-area" class="input" placeholder='Colle JSON [{"locker":101,"uid":"ABC123"}] ou CSV locker,uid'></textarea>
        <p class="note">Les imports modifient le <b>cache local</b>. Utilise üíæ pour pousser vers Firestore (selon tes droits).</p>
      </div>
    </div>
  </section>
</main>

<!-- Bottom nav -->
<nav class="bnav" role="navigation" aria-label="Navigation principale">
  <div class="bwrap">
    <button id="bnav-kiosk" class="bbtn active">üßæ<span>Kiosk</span></button>
    <button id="bnav-admin" class="bbtn">‚öôÔ∏è<span>Admin</span></button>
    <button id="bnav-tools" class="bbtn" onclick="document.getElementById('btn-hamb').click()">‚ò∞<span>Outils</span></button>
  </div>
</nav>

<!-- Floating camera -->
<button id="fab-camera" class="fab" aria-pressed="false">üì∑ Activer cam√©ra</button>

<!-- ================= SCRIPTS ================= -->
<script type="module">
/* Firebase v9 */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc, getDocs, collection, query, orderBy, where, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZ7M8dUKqcUwa9rDyWEdHEwnFVPlrpCds",
  authDomain: "lockers-26331.firebaseapp.com",
  projectId: "lockers-26331",
  storageBucket: "lockers-26331.firebasestorage.app",
  messagingSenderId: "601816918378",
  appId: "1:601816918378:web:b6045b10b60e7957c19d13"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ===== Views / Nav ===== */
const viewKiosk = document.getElementById("view-kiosk");
const viewAdmin = document.getElementById("view-admin");
const bKiosk = document.getElementById("bnav-kiosk");
const bAdmin = document.getElementById("bnav-admin");
function setView(name){
  const isKiosk = name==="kiosk";
  viewKiosk.style.display = isKiosk ? "block" : "none";
  viewAdmin.style.display  = isKiosk ? "none"  : "block";
  bKiosk.classList.toggle("active", isKiosk);
  bAdmin.classList.toggle("active", !isKiosk);
}
bKiosk.onclick = ()=>setView("kiosk");
bAdmin.onclick = ()=>setView("admin");
setView("kiosk");

/* ===== Drawer ===== */
const drawer = document.getElementById("drawer");
const btnHamb = document.getElementById("btn-hamb");
document.getElementById("drawer-close").onclick = ()=> drawer.classList.remove("open");
btnHamb.onclick = ()=> drawer.classList.toggle("open");

/* ===== State / helpers ===== */
const LS_KEY="hedo_lockers_cache_v12";
let state = { map: [], isAuthed:false, isAdmin:false, uid:null };
const saveLocal = ()=> localStorage.setItem(LS_KEY, JSON.stringify({map:state.map}));
const loadLocal = ()=> { try{const o=JSON.parse(localStorage.getItem(LS_KEY)||"{}"); if(Array.isArray(o.map)) state.map=o.map;}catch{} };
const normalize = (s)=> (s||"").trim();
const showLocker = (locker)=> document.getElementById("kiosk-content").innerHTML =
  locker ? `<div class="note">Votre casier est le</div><div class="big">#${String(locker).padStart(3,"0")}</div>` : `<span class="note">Aucun casier trouv√©.</span>`;

/* Visibilit√© des outils apr√®s login */
function setAuthUI(isAuthed){
  document.querySelectorAll("[data-authonly]").forEach(el=>{
    el.classList.toggle("show", !!isAuthed);
  });
}

/* ===== Firestore DAO ===== */
const LOCKERS = () => collection(db,"lockers");
const LOCKER  = (id)=> doc(db,"lockers",String(id));
const ADMINS  = (uid)=> doc(db,"admins",String(uid));
const padId = (n)=> {
  const num = Number(n);
  if (Number.isNaN(num) || num < 0) return String(n||"");
  return String(num).padStart(3,"0"); // 001..999
};

/* Upsert: ajoute createdBy seulement √† la cr√©ation (owner-based) */
async function dbUpsert(locker, uid){
  const id = padId(locker);
  const ref = LOCKER(id);
  const snap = await getDoc(ref);

  const payload = {
    locker: Number(locker),
    uid: uid || null,
    updatedAt: serverTimestamp()
  };
  if (!snap.exists()) {
    payload.createdBy = auth.currentUser ? auth.currentUser.uid : null;
  }
  await setDoc(ref, payload, { merge: true });
}
async function dbDelete(locker){
  const id = padId(locker);
  await deleteDoc(LOCKER(id));
}
async function dbFindByUID(uid){
  const qs = await getDocs(query(LOCKERS(), where("uid","==",uid)));
  if (qs.empty) return null;
  const first = qs.docs[0]; return first.data().locker ?? Number(first.id);
}

/* ===== Realtime ===== */
function startRealtime(){
  onSnapshot(query(LOCKERS(), orderBy("locker")), snap=>{
    state.map = snap.docs.map(d=>({ locker:Number((d.data()?.locker) ?? d.id), ...(d.data()||{}) }));
    saveLocal(); renderCards();
  });
}

/* ===== Auth ===== */
const emailInput = document.getElementById("admin-email");
const passInput  = document.getElementById("admin-pass");
const rememberMe = document.getElementById("remember-me");
const btnLogin   = document.getElementById("btn-login");
const btnLogout  = document.getElementById("btn-logout");
const authStatus = document.getElementById("auth-status");
const roleStatus = document.getElementById("role-status");

btnLogin.onclick = async ()=>{
  try{
    const email = normalize(emailInput.value);
    const pass  = normalize(passInput.value);
    if(!email || !pass) return alert("Email et mot de passe requis.");

    await setPersistence(auth, rememberMe.checked ? browserLocalPersistence : browserSessionPersistence);
    await signInWithEmailAndPassword(auth, email, pass);

    if (rememberMe.checked) {
      localStorage.setItem("hedo_last_email", email);
      localStorage.setItem("hedo_remember", "1");
    } else {
      localStorage.removeItem("hedo_last_email");
      localStorage.removeItem("hedo_remember");
    }

    drawer.classList.remove("open");
  }catch(e){
    alert("Erreur connexion : " + (e.message || e));
  }
};
btnLogout.onclick = ()=> signOut(auth);

// Pr√©remplir email/checkbox au chargement
try{
  const last = localStorage.getItem("hedo_last_email") || "";
  const rem  = localStorage.getItem("hedo_remember") === "1";
  if (last) emailInput.value = last;
  rememberMe.checked = rem;
}catch{}

onAuthStateChanged(auth, async (user)=>{
  authStatus.textContent = user ? `Connect√©: ${user.email}` : "Non connect√©";
  state.uid = user ? user.uid : null;
  state.isAuthed = !!user;
  state.isAdmin = false;
  if (user){
    const d = await getDoc(ADMINS(user.uid));
    state.isAdmin = d.exists();
  }
  roleStatus.textContent = state.isAdmin ? "‚Ä¢ Admin" : "";
  setAuthUI(state.isAuthed);
  renderCards();
});

/* ===== Admin as cards ===== */
const cards = document.getElementById("cards");
const search = document.getElementById("search");
let scanTargetInput = null; // QR ‚Üí remplit cet input si d√©fini

function renderCards(){
  const q = (search?.value||"").toLowerCase();
  const rows = state.map.slice().sort((a,b)=>a.locker-b.locker)
    .filter(r=>!q || String(r.locker).includes(q) || (r.uid||"").toLowerCase().includes(q));

  cards.innerHTML="";
  rows.forEach(r=>{
    // Permissions owner/admin
    const ownerUid = r.createdBy || null;
    const canDelete = state.isAdmin || (!!ownerUid && ownerUid === state.uid);
    const canSave   = state.isAdmin || (!!ownerUid && ownerUid === state.uid);
    const ownerTag  = ownerUid ? (ownerUid === state.uid ? " (moi)" : "") : "";

    const card = document.createElement("div");
    card.className = "acard";
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;gap:12px">
        <div style="flex:0 0 120px">
          <div class="lbl">Casier${ownerTag}</div>
          <input class="input locker" value="${String(r.locker).padStart(3,'0')}" ${state.isAuthed?"":"disabled"} />
        </div>
        <div style="flex:1">
          <div class="lbl">UID</div>
          <input class="input uid" value="${r.uid||""}" placeholder="${state.isAuthed?'Scanner‚Ä¶ (clavier ou üì∑)':'Connecte-toi pour √©diter'}" ${state.isAuthed?"":"disabled"} />
        </div>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:6px">
          <button class="btn inline" data-act="scan-kb" ${state.isAuthed?"":"disabled"}>Scanner (clavier)</button>
          <button class="btn inline" data-act="scan-cam" ${state.isAuthed?"":"disabled"}>üì∑ Scanner (cam√©ra)</button>
          <button class="btn inline" data-act="convert" ${state.isAuthed?"":"disabled"}>üîÅ Convertir</button>
          <button class="btn inline ghost" data-act="clear" ${state.isAuthed?"":"disabled"}>Vider UID</button>
        </div>
        <div class="row" style="gap:6px">
          <button class="btn inline accent" data-act="save" ${state.isAuthed && canSave ? "" : "disabled"} title="${canSave?'':'√âcriture autoris√©e: admin ou cr√©ateur'}">üíæ Enregistrer</button>
          <button class="btn inline danger" data-act="del" ${state.isAuthed && canDelete ? "" : "disabled"} title="${canDelete?'':'Suppression autoris√©e: admin ou cr√©ateur'}">üóëÔ∏è Supprimer</button>
          <button class="btn inline" data-act="remove-local" ${state.isAuthed && !canDelete ? "" : "style='display:none'"}>üßπ Retirer (local)</button>
        </div>
      </div>`;
    cards.appendChild(card);

    const lockerEl = card.querySelector(".locker");
    const uidEl = card.querySelector(".uid");

    // Scanner clavier (douchette)
    card.querySelector('[data-act="scan-kb"]').onclick = ()=>{
      if(!state.isAuthed) return alert("Connecte-toi pour utiliser cet outil.");
      uidEl.focus(); uidEl.value="";
      const handler=(e)=>{ if(e.key==="Enter"){ uidEl.value = normalize(uidEl.value); document.removeEventListener("keydown",handler,true);} };
      document.addEventListener("keydown", handler, true);
    };

    // Scanner cam√©ra ‚Üí remplit l'UID de cette carte (valeur convertie)
    card.querySelector('[data-act="scan-cam"]').onclick = async ()=>{
      if(!state.isAuthed) return alert("Connecte-toi pour utiliser cet outil.");
      scanTargetInput = uidEl;
      if(!cameraRunning) await startCamera();
    };

    // Convertir manuellement le contenu UID
    const btnConvert = card.querySelector('[data-act="convert"]');
    if (btnConvert){
      btnConvert.onclick = ()=>{
        fmt = loadFmt();
        uidEl.value = convertRFID(uidEl.value || "");
      };
    }

    // Vider UID
    card.querySelector('[data-act="clear"]').onclick = ()=>{ if(state.isAuthed) uidEl.value=""; };

    // Enregistrer (upsert) ‚Äî owner/admin
    card.querySelector('[data-act="save"]').onclick = async ()=>{
      if(!state.isAuthed) return alert("Connecte-toi d‚Äôabord.");
      if(!(state.isAdmin || (r.createdBy && r.createdBy === state.uid))) return alert("√âcriture autoris√©e uniquement pour l‚Äôadmin ou le cr√©ateur.");
      const Lnum = Number(lockerEl.value);
      if(!Lnum) return alert("Num√©ro de casier invalide.");
      const U = normalize(uidEl.value) || null;
      try{ await dbUpsert(Lnum, U); }catch(e){ alert("Erreur: "+(e.message||e)); }
    };

    // Supprimer (base) ‚Äî owner/admin
    card.querySelector('[data-act="del"]').onclick = async ()=>{
      if(!state.isAuthed) return alert("Connecte-toi d‚Äôabord.");
      if(!(state.isAdmin || (r.createdBy && r.createdBy === state.uid))) return alert("Suppression autoris√©e uniquement pour l‚Äôadmin ou le cr√©ateur.");
      if(!confirm("Supprimer ce casier en base ?")) return;
      try{ await dbDelete(Number(lockerEl.value)); }catch(e){ alert("Suppression refus√©e : " + (e.message||e)); }
    };

    // Retirer (local) ‚Äî pour non-autoris√©s
    const removeLocalBtn = card.querySelector('[data-act="remove-local"]');
    if (removeLocalBtn){
      removeLocalBtn.onclick = ()=>{
        const Lnum = Number(lockerEl.value);
        state.map = state.map.filter(x => Number(x.locker)!==Lnum);
        saveLocal(); renderCards();
        alert("Ligne retir√©e localement (non persist√©e).");
      };
    }
  });
}
search?.addEventListener("input", renderCards);

document.getElementById("btn-add-card").onclick = ()=>{
  if(!state.isAuthed) return alert("Connecte-toi d‚Äôabord.");
  state.map.push({ locker:0, uid:"" }); saveLocal(); renderCards();
};
document.getElementById("btn-create-001-130").onclick = async ()=>{
  if(!state.isAuthed) return alert("Connecte-toi d‚Äôabord.");
  if(!state.isAdmin) return alert("Cr√©ation en base r√©serv√©e aux admins.");
  if(!confirm("Cr√©er/mettre √† jour les casiers 001 ‚Üí 130 (UID vides) ?")) return;
  try{
    const batch = writeBatch(db);
    for(let n=1;n<=130;n++){
      const id = padId(n);
      batch.set(LOCKER(id), { locker:n, uid:null, updatedAt:serverTimestamp(), createdBy: auth.currentUser?.uid || null }, { merge:true });
    }
    await batch.commit();
    alert("Casiers 001‚Üí130 cr√©√©s/rafra√Æchis.");
  }catch(e){ alert("Erreur: "+(e.message||e)); }
};
/* Drawer shortcut */
document.getElementById("drawer-create-001-130").onclick = ()=> document.getElementById("btn-create-001-130").click();

/* ===== Import / Export (local cache) ===== */
const area = document.getElementById("import-area");
function downloadText(filename, text){
  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}
function mustAuth(){ if(!state.isAuthed){ alert("Connecte-toi d‚Äôabord."); return true; } return false; }
function exportJSON(){ if(mustAuth()) return; downloadText("hedo-lockers.json", JSON.stringify(state.map,null,2)); }
function exportCSV(){
  if(mustAuth()) return;
  const rows=[["locker","uid"],...state.map.map(r=>[r.locker,r.uid||""])];
  const csv=rows.map(r=>r.map(c=>String(c).replace(/"/g,'""')).join(",")).join("\n");
  downloadText("hedo-lockers.csv", csv);
}
function importJSON(){
  if(mustAuth()) return;
  try{ const arr=JSON.parse(area.value); if(!Array.isArray(arr)) throw new Error("JSON invalide");
    state.map=arr.map(o=>({locker:Number(o.locker),uid:normalize(o.uid||"")})).filter(o=>o.locker);
    saveLocal(); renderCards(); alert("Import local OK");
  }catch(e){ alert("Erreur: "+e.message); }
}
function importCSV(){
  if(mustAuth()) return;
  try{ const lines=area.value.trim().split(/\r?\n/); const out=[];
    for(let i=0;i<lines.length;i++){ const line=lines[i].trim(); if(!line)continue;
      const parts=line.split(","); if(i===0 && /locker/i.test(parts[0])) continue;
      const locker=Number(parts[0]); const uid=normalize(parts[1]||""); if(locker) out.push({locker,uid});
    }
    state.map=out; saveLocal(); renderCards(); alert("Import local OK");
  }catch(e){ alert("Erreur: "+e.message); }
}
document.getElementById("btn-export-json").onclick = exportJSON;
document.getElementById("btn-export-csv").onclick = exportCSV;
document.getElementById("btn-import-json").onclick = importJSON;
document.getElementById("btn-import-csv").onclick = importCSV;
document.getElementById("drawer-export-json").onclick = exportJSON;
document.getElementById("drawer-export-csv").onclick = exportCSV;
document.getElementById("drawer-import-json").onclick = importJSON;
document.getElementById("drawer-import-csv").onclick = importCSV;

/* ===== Import via fichier (CSV / XLSX / XLS) ===== */
const fileInput = document.getElementById("file-input");
const btnImportFile = document.getElementById("btn-import-file");
const drawerImportFile = document.getElementById("drawer-import-file");

function askFile(){ if (!state.isAuthed) { alert("Connecte-toi d‚Äôabord."); return; } fileInput.value=""; fileInput.click(); }
btnImportFile.onclick = askFile;
drawerImportFile.onclick = askFile;

fileInput.addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if (!f) return;
  const name = (f.name || "").toLowerCase();

  try{
    if (name.endsWith(".numbers")){
      alert("Les fichiers .numbers ne peuvent pas √™tre lus directement. Dans Numbers : Fichier ‚Üí Exporter vers‚Ä¶ ‚Üí CSV (ou Excel), puis r√©essaie.");
      return;
    }

    if (window.XLSX && (name.endsWith(".xlsx") || name.endsWith(".xls") || name.endsWith(".csv"))){
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      let rows = XLSX.utils.sheet_to_json(ws, { defval: "", raw: false });

      const normKey = (s)=> (s||"").toString().trim().toLowerCase().replace(/\s+/g,"");
      rows = rows.map(r=>{
        const obj = {};
        for (const k in r){
          const nk = normKey(k);
          if (nk === "locker" || nk === "casier" || nk === "n¬∞" || nk === "numero" || nk === "num√©ro"){
            obj.locker = Number(String(r[k]).trim());
          } else if (nk === "uid" || nk === "code" || nk === "bracelet" || nk === "rfid"){
            obj.uid = String(r[k]).trim();
          }
        }
        return obj;
      }).filter(o=>o.locker);

      if (!rows.length){
        alert("Aucune ligne valide trouv√©e. Attendu : colonnes ‚Äòlocker‚Äô (ou ‚Äòcasier‚Äô) et ‚Äòuid‚Äô.");
        return;
      }

      state.map = rows.map(o=>({ locker: Number(o.locker), uid: (o.uid||"").trim() }));
      saveLocal(); renderCards();
      alert(`Import depuis fichier : ${state.map.length} lignes charg√©es (cache local). Utilise üíæ pour pousser vers Firestore (selon tes droits).`);
      return;
    }

    if (name.endsWith(".csv")){
      const text = await f.text();
      document.getElementById("import-area").value = text;
      importCSV();
      return;
    }

    alert("Format non support√©. Utilise CSV, XLSX ou XLS.");
  }catch(err){
    console.error(err);
    alert("Erreur d‚Äôimport : " + (err.message || err));
  }
});

/* ======= FORMAT LECTEUR RFID (conversion configurable + pr√©-mapping clavier) ======= */
const LS_FMT = "hedo_rfid_format_v1";
const fmtEl = {
  prefix: document.getElementById("fmt-prefix"),
  suffix: document.getElementById("fmt-suffix"),
  cutStart: document.getElementById("fmt-cut-start"),
  cutEnd: document.getElementById("fmt-cut-end"),
  delim: document.getElementById("fmt-delim"),
  segIndex: document.getElementById("fmt-seg-index"),
  regex: document.getElementById("fmt-regex"),
  keepAlnum: document.getElementById("fmt-keep-alnum"),
  upper: document.getElementById("fmt-upper"),
  hex2dec: document.getElementById("fmt-hex2dec"),
  dec2hex: document.getElementById("fmt-dec2hex"),
  hexPad: document.getElementById("fmt-hex-pad"),
  wMode: document.getElementById("fmt-wiegand-mode"),
  wIn: document.getElementById("fmt-wiegand-in"),
  wOut: document.getElementById("fmt-wiegand-out"),
  tpl: document.getElementById("fmt-template"),
  tIn: document.getElementById("fmt-test-in"),
  tOut: document.getElementById("fmt-test-out"),
  tRun: document.getElementById("fmt-test-run"),
  save: document.getElementById("fmt-save"),
  reset: document.getElementById("fmt-reset"),
};

const defaultFmt = {
  prefix:"", suffix:"", cutStart:0, cutEnd:0,
  delim:"", segIndex:0, regex:"",
  keepAlnum:true, upper:true,
  hex2dec:false, dec2hex:false, hexPad:0,
  wMode:"off", wIn:"dec", wOut:"fc-cn",
  tpl:"{norm}"
};

function loadFmt(){
  try{
    const o = JSON.parse(localStorage.getItem(LS_FMT) || "null") || defaultFmt;
    fmtEl.prefix.value = o.prefix || ""; fmtEl.suffix.value = o.suffix || "";
    fmtEl.cutStart.value = o.cutStart || 0; fmtEl.cutEnd.value = o.cutEnd || 0;
    fmtEl.delim.value = o.delim || ""; fmtEl.segIndex.value = o.segIndex || 0;
    fmtEl.regex.value = o.regex || "";
    fmtEl.keepAlnum.checked = !!o.keepAlnum; fmtEl.upper.checked = !!o.upper;
    fmtEl.hex2dec.checked = !!o.hex2dec; fmtEl.dec2hex.checked = !!o.dec2hex;
    fmtEl.hexPad.value = o.hexPad || 0;
    fmtEl.wMode.value = o.wMode || "off"; fmtEl.wIn.value = o.wIn || "dec"; fmtEl.wOut.value = o.wOut || "fc-cn";
    fmtEl.tpl.value = o.tpl || "{norm}";
    return o;
  }catch{ return defaultFmt; }
}
function saveFmt(){
  const o = {
    prefix: fmtEl.prefix.value || "",
    suffix: fmtEl.suffix.value || "",
    cutStart: Number(fmtEl.cutStart.value||0),
    cutEnd: Number(fmtEl.cutEnd.value||0),
    delim: fmtEl.delim.value || "",
    segIndex: Number(fmtEl.segIndex.value||0),
    regex: fmtEl.regex.value || "",
    keepAlnum: !!fmtEl.keepAlnum.checked,
    upper: !!fmtEl.upper.checked,
    hex2dec: !!fmtEl.hex2dec.checked,
    dec2hex: !!fmtEl.dec2hex.checked,
    hexPad: Number(fmtEl.hexPad.value||0),
    wMode: fmtEl.wMode.value || "off",
    wIn: fmtEl.wIn.value || "dec",
    wOut: fmtEl.wOut.value || "fc-cn",
    tpl: fmtEl.tpl.value || "{norm}"
  };
  localStorage.setItem(LS_FMT, JSON.stringify(o));
  return o;
}
let fmt = loadFmt();
fmtEl.save?.addEventListener("click", ()=>{ fmt = saveFmt(); alert("Format enregistr√©."); });
fmtEl.reset?.addEventListener("click", ()=>{
  localStorage.removeItem(LS_FMT); fmt = loadFmt(); alert("Format r√©initialis√©.");
});

/* --- PREMAP CLAVIER ‚Üí CHIFFRES (AZERTY FR + variantes) --- */
function mapKeyboardToDigits(str){
  if (!str) return "";
  const map = {
    // Ligne chiffres azerty sans Shift: & √© " ' ( - √® _ √ß √†
    "&":"1","√©":"2",'"':"3","'":"4","(":"5","-":"6","√®":"7","_":"8","√ß":"9","√†":"0",
    // Majuscules / variantes
    "√â":"2","√à":"7","√á":"9","√Ä":"0",
    // Combinaisons shift usuelles
    "!":"1", // shift+&
    // Layout DE/CH: '¬ß' (souvent Shift+3)
    "¬ß":"3"
  };
  let out = "";
  for (const ch of str) out += (map[ch] ?? ch);
  return out;
}

// Conversion principale (inclut le pr√©-mapping clavier)
function convertRFID(raw){
  // Pr√©-mapping clavier -> chiffres
  let s = mapKeyboardToDigits((raw ?? "").toString());

  // Pr√©fixe/suffixe
  if (fmt.prefix && s.startsWith(fmt.prefix)) s = s.slice(fmt.prefix.length);
  if (fmt.suffix && s.endsWith(fmt.suffix)) s = s.slice(0, -fmt.suffix.length);

  // Couper d√©but/fin
  const cs = Math.max(0, Number(fmt.cutStart||0));
  const ce = Math.max(0, Number(fmt.cutEnd||0));
  if (cs) s = s.slice(cs);
  if (ce) s = s.slice(0, s.length - ce);

  // D√©limiteur / segment
  if (fmt.delim){
    const parts = s.split(fmt.delim);
    const idx = Math.max(0, Number(fmt.segIndex||0));
    if (parts[idx] != null) s = parts[idx];
  }

  // Regex capture (groupe 1)
  if (fmt.regex){
    try{
      const m = new RegExp(fmt.regex).exec(s);
      if (m && m[1] != null) s = m[1];
    }catch{}
  }

  // Nettoyage + casse
  if (fmt.keepAlnum) s = s.replace(/[^0-9a-zA-Z]/g, "");
  s = fmt.upper ? s.toUpperCase() : s.toLowerCase();

  // Hex ‚áÜ Dec
  let valDec = null, valHex = null;
  if (fmt.hex2dec){
    const hex = s.replace(/^0x/i,"");
    const n = parseInt(hex, 16);
    if (!Number.isNaN(n)){ valDec = n; s = String(n); }
  } else if (fmt.dec2hex){
    const n = parseInt(s, 10);
    if (!Number.isNaN(n)){
      let h = n.toString(16);
      const pad = Math.max(0, Number(fmt.hexPad||0));
      if (pad) h = h.padStart(pad, "0");
      s = (fmt.upper ? h.toUpperCase() : h.toLowerCase());
      valHex = s;
    }
  }

  // Wiegand 26/34 (optionnel)
  let fc = null, cn = null;
  if (fmt.wMode !== "off"){
    let n;
    if (fmt.wIn === "hex") n = parseInt(s.replace(/^0x/i,""), 16);
    else n = parseInt(s, 10);

    if (!Number.isNaN(n)){
      if (fmt.wMode === "w26"){
        const data24 = (n >>> 1) & 0xFFFFFF; // ignore parit√©s
        fc = (data24 >>> 16) & 0xFF;
        cn = data24 & 0xFFFF;
      } else if (fmt.wMode === "w34"){
        const data32 = (n >>> 1) >>> 0;
        fc = (data32 >>> 16) & 0xFFFF;
        cn = data32 & 0xFFFF;
      }
      if (fmt.wOut === "fc-cn" && fc != null && cn != null) s = `${fc}-${cn}`;
      else if (fmt.wOut === "fc_card" && fc != null && cn != null) s = `${fc}.${cn}`;
      else if (fmt.wOut === "card" && cn != null) s = String(cn);
    }
  }

  // Gabarit
  const out = (fmt.tpl || "{norm}")
    .replace(/{raw}/g, (raw ?? "").toString())
    .replace(/{norm}/g, s)
    .replace(/{hex}/g, (valHex != null ? valHex : (()=>{ try{
      const n = parseInt(s,10); if(!Number.isNaN(n)) return (fmt.upper?n.toString(16).toUpperCase():n.toString(16));
    }catch{} return ""; })()))
    .replace(/{dec}/g, (valDec != null ? String(valDec) : (()=>{ try{
      const n = parseInt(s,fmt.dec2hex?16:10); if(!Number.isNaN(n)) return String(n);
    }catch{} return ""; })()))
    .replace(/{fc}/g, fc != null ? String(fc) : "")
    .replace(/{cn}/g, cn != null ? String(cn) : "");

  return (out || s).trim();
}

// Test live
fmtEl.tRun?.addEventListener("click", ()=>{
  fmt = saveFmt();
  const r = convertRFID(fmtEl.tIn.value || "");
  fmtEl.tOut.textContent = r || "‚Äî";
});

/* ===== Kiosk ‚Äì scan clavier (avec conversion) ===== */
const hiddenInput = document.getElementById("hidden-capture");
let buffer="";
function focusCapture(){ hiddenInput.focus(); }
hiddenInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ const data=buffer; buffer=""; onScan(data); }
  else if(e.key.length===1){ buffer+=e.key; }
  else if(e.key==="Backspace"){ buffer=buffer.slice(0,-1); }
});
document.addEventListener("click",(e)=>{ if(viewKiosk.contains(e.target)) setTimeout(focusCapture,0); });
focusCapture();

async function onScan(raw){
  // Conversion normalis√©e
  fmt = loadFmt();
  const token0 = normalize(raw);
  const token = convertRFID(token0);
  if(!token || token.length<1) return;

  // Mode Admin cibl√© ?
  if (scanTargetInput){
    scanTargetInput.value = token;
    if (navigator.vibrate) navigator.vibrate(60);
    scanTargetInput = null;
    await stopCamera();
    return;
  }

  // Mode Kiosk : recherche casier
  const row = state.map.find(r => (r.uid||"") === token);
  if (row){ showLocker(row.locker); return; }
  try{ const locker = await dbFindByUID(token); showLocker(locker); }catch{ showLocker(null); }
}

/* ===== Cam√©ra ‚Äî BarcodeDetector natif ‚Üí jsQR fallback (sans ZXing) ===== */
const video = document.getElementById("qr-video");
const camDot = document.getElementById("cam-dot");
const camLabel = document.getElementById("cam-label");
const fabCamera = document.getElementById("fab-camera");
const camRestartBtn = document.getElementById("cam-restart");

let cameraRunning = false;
let stream = null;
let stopDecoder = null;

function setCamStatus(kind,msg){
  camDot.className = "dot " + (kind||"warn");
  camLabel.textContent = "Cam√©ra : " + (msg||"");
  if (cameraRunning){
    fabCamera.textContent="‚èπÔ∏è Arr√™ter cam√©ra";
    fabCamera.classList.add("alt");
    fabCamera.setAttribute("aria-pressed","true");
  } else {
    fabCamera.textContent="üì∑ Activer cam√©ra";
    fabCamera.classList.remove("alt");
    fabCamera.setAttribute("aria-pressed","false");
  }
}
function showCamError(e){
  const name=e?.name||"", msg=e?.message||String(e);
  let extra=" ‚Ä¢ R√©glages > Safari/Chrome ‚Üí Appareil photo : ‚ÄòAutoriser/Demander‚Äô.";
  if (window.top !== window.self) extra += " ‚Ä¢ Si int√©gr√© (Wix), mettre allow=\"camera\" sur l‚Äôiframe.";
  document.getElementById("kiosk-error").textContent = `Cam√©ra indisponible (${name||"Erreur"}): ${msg}${extra}`;
  console.error("Camera error:", e);
  setCamStatus("err","erreur");
}

/* Warm-up (tap user) */
async function warmUpPermission(){
  const gum = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:{ ideal:"environment" }, width:{ideal:1280}, height:{ideal:720} },
    audio:false
  });
  gum.getTracks().forEach(t=>t.stop());
}

/* Start camera + decoder (conversion via handleDecodedText‚ÜíonScan) */
async function startCamera(){
  try{
    setCamStatus("warn","permission‚Ä¶");
    await warmUpPermission();

    setCamStatus("warn","d√©marrage‚Ä¶");
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:"environment" }, width:{ideal:1280}, height:{ideal:720} },
      audio:false
    });
    video.srcObject = stream;
    await video.play();

    if ("BarcodeDetector" in window){
      const formats = await (window.BarcodeDetector.getSupportedFormats?.()||[]);
      if (!formats.length || formats.includes("qr_code")){
        stopDecoder = startBarcodeDetectorLoop(video);
        cameraRunning = true; setCamStatus("ok","op√©rationnelle (natif)");
        return;
      }
    }
    if (window.jsQR){
      stopDecoder = startJsQRLoop(video);
      cameraRunning = true; setCamStatus("ok","op√©rationnelle (jsQR)");
      return;
    }
    throw new Error("Aucun d√©codeur dispo (BarcodeDetector/jsQR).");
  }catch(e){
    cameraRunning = false;
    await stopCamera();
    showCamError(e);
  }
}

async function stopCamera(){
  try{ if (stopDecoder) { stopDecoder(); stopDecoder=null; } }catch{}
  try{ if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch{}
  try{ if (video){ video.pause(); video.srcObject=null; } }catch{}
  cameraRunning=false;
  setCamStatus("warn","arr√™t√©e");
}

function startBarcodeDetectorLoop(videoEl){
  const detector = new window.BarcodeDetector({ formats:["qr_code"] });
  let stopped=false;
  async function tick(){
    if (stopped) return;
    try{
      const res = await detector.detect(videoEl);
      if (res && res.length){
        const txt = res[0].rawValue || "";
        if (txt){
          handleDecodedText(txt);
          if (navigator.vibrate) navigator.vibrate(60);
          if (scanTargetInput){ await stopCamera(); }
        }
      }
    }catch{}
    finally{ if (!stopped) requestAnimationFrame(tick); }
  }
  requestAnimationFrame(tick);
  return ()=>{ stopped=true; };
}

function startJsQRLoop(videoEl){
  const cvs=document.createElement("canvas");
  const ctx=cvs.getContext("2d",{willReadFrequently:true});
  let stopped=false;
  function frame(){
    if (stopped) return;
    const w=videoEl.videoWidth||640, h=videoEl.videoHeight||480;
    if (w && h){
      cvs.width=w; cvs.height=h;
      ctx.drawImage(videoEl,0,0,w,h);
      const imgData = ctx.getImageData(0,0,w,h);
      const res = window.jsQR(imgData.data, w, h, { inversionAttempts:"attemptBoth" });
      if (res?.data){
        handleDecodedText(res.data);
        if (navigator.vibrate) navigator.vibrate(60);
        if (scanTargetInput){ stopCamera(); }
      }
    }
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
  return ()=>{ stopped=true; };
}

async function handleDecodedText(text){
  // Conversion appliqu√©e ici pour les scans cam√©ra (Admin + Kiosk)
  fmt = loadFmt();
  const converted = convertRFID(text || "");
  if (!converted) return;
  if (scanTargetInput){
    scanTargetInput.value = converted; // injecte la valeur convertie dans le champ UID cibl√©
    return;
  }
  if (typeof onScan === "function"){ onScan(converted); } // Kiosk
}

/* Buttons */
const fabCamera = document.getElementById("fab-camera");
fabCamera.onclick = async ()=>{ if (cameraRunning) await stopCamera(); else await startCamera(); };
const camRestartBtn = document.getElementById("cam-restart");
camRestartBtn?.addEventListener("click", ()=>{ if(cameraRunning) stopCamera().then(startCamera); else startCamera(); });

/* Resume after background */
document.addEventListener("visibilitychange", ()=>{
  if (document.visibilityState === "visible" && cameraRunning){
    stopCamera().then(startCamera).catch(()=>{});
  }
});

/* ===== Reset local ===== */
document.getElementById("btn-reset").onclick = ()=>{
  if(!confirm("R√©initialiser le cache local ?")) return;
  localStorage.removeItem(LS_KEY);
  state.map=[]; renderCards();
  document.getElementById("kiosk-content").textContent="Scannez votre bracelet‚Ä¶";
  document.getElementById("kiosk-error").textContent="";
};

/* ===== Boot ===== */
loadLocal(); setAuthUI(false); renderCards(); startRealtime();

/* ===== SW ===== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  });
}

/* ===== Standalone detection ===== */
function isStandalone(){
  return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);
}
if (isStandalone()){
  document.body.classList.add("standalone");
}
</script>
</body>
</html>